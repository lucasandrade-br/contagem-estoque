<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Contagem de Estoque - Padaria{% endblock %}</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração Tailwind para cores personalizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'amber': {
                            500: '#f59e0b',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#f59e0b">
    <meta name="description" content="Sistema de inventário e contagem de estoque com suporte offline">
    
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-slate-900 text-gray-100 font-sans antialiased">
    <!-- Menu de Navegação para Gerente -->
    {% if is_gerente %}
    <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="{{ url_for('admin.dashboard') }}" 
                       class="text-amber-500 hover:text-amber-400 font-semibold transition-colors">
                        Dashboard
                    </a>
                    
                </div>
                <a href="{{ url_for('auth.index') }}" 
                   class="text-gray-300 hover:text-gray-100 transition-colors">
                    Sair
                </a>
            </div>
        </div>
    </nav>
    {% endif %}
    
    {% block content %}{% endblock %}
    
    {% block extra_scripts %}{% endblock %}

    <!-- GLOBAL LOADER/SPINNER -->
    <div id="global-loader" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="flex flex-col items-center gap-4">
            <div class="relative w-16 h-16">
                <svg class="animate-spin h-16 w-16 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <p class="text-white font-semibold text-lg">Processando...</p>
        </div>
    </div>

    <!-- GLOBAL LOADER CONTROL SCRIPT -->
    <script>
        /**
         * Controla a visibilidade do loader global
         */
        function mostrarLoader() {
            document.getElementById('global-loader').classList.remove('hidden');
        }

        function ocultarLoader() {
            document.getElementById('global-loader').classList.add('hidden');
        }

        /**
         * Automação de loader para formulários e botões
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar loader ao submeter formulários de login e críticos
            const formsComLoader = document.querySelectorAll(
                'form[action*="login"], form[action*="upload_erp"], form[action*="fechar_inventario"]'
            );
            
            formsComLoader.forEach(form => {
                // Verificar se o formulário tem onsubmit com confirm (não adicionar listener duplicado)
                const temConfirm = form.hasAttribute('onsubmit') && form.getAttribute('onsubmit').includes('confirm');
                
                if (!temConfirm) {
                    // Formulário SEM confirm: adicionar loader normalmente
                    form.addEventListener('submit', function(e) {
                        if (form.checkValidity() !== false) {
                            mostrarLoader();
                        }
                    });
                } else {
                    // Formulário COM confirm: só mostrar loader se usuário confirmar
                    const originalOnsubmit = form.onsubmit;
                    form.onsubmit = function(e) {
                        const confirmed = originalOnsubmit.call(this, e);
                        if (confirmed !== false) {
                            mostrarLoader();
                        }
                        return confirmed;
                    };
                }
            });

            // Mostrar loader ao clicar em botões de download de Excel
            const botoesDownload = document.querySelectorAll('a[href*="exportar_excel"], a[href*="exportar_csv"]');
            botoesDownload.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    mostrarLoader();
                    // Ocultar loader após 5 segundos (download deve ter completado)
                    setTimeout(ocultarLoader, 5000);
                });
            });

            // Ocultar loader automaticamente quando a página terminar de carregar
            window.addEventListener('load', function() {
                setTimeout(ocultarLoader, 500);
            });
        });
    </script>

    <!-- Service Worker Registration (PWA) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('{{ url_for("static", filename="sw.js") }}')
                    .then(registration => {
                        console.log('[App] Service Worker registered:', registration);
                    })
                    .catch(err => {
                        console.log('[App] Service Worker registration failed:', err);
                    });
            });
        }
    </script>


    {% if is_gerente %} 
    <script>
        (function() {
            // Configuração
            const INTERVALO_CHECK = 5000; // 5 segundos
            let versaoLocal = null;
            let timer = null;

            async function verificarAtualizacoes() {
                try {
                    const response = await fetch('/api/heartbeat');
                    const data = await response.json();

                    // 1. Se o inventário fechou, para de verificar
                    if (!data.ativo) {
                        console.log("Inventário fechado ou inativo. Parando monitoramento.");
                        if (timer) clearInterval(timer);
                        return;
                    }

                    // 2. Primeira execução: Guarda a versão atual e não faz nada
                    if (versaoLocal === null) {
                        versaoLocal = data.versao;
                        return;
                    }

                    // 3. Se a versão mudou (alguém contou algo ou abriu ocorrência)
                    if (data.versao !== versaoLocal) {
                        console.log("Novos dados detectados! Atualizando...");
                        
                        // Mostra um feedback visual discreto antes de recarregar
                        const badge = document.getElementById('update-badge');
                        if(badge) badge.classList.remove('hidden');

                        // RECARREGA A PÁGINA PARA PEGAR DADOS NOVOS
                        // Opção Simples: Reload total (Funciona 100% em todas as telas)
                        window.location.reload(); 
                        
                        // Opção Avançada (AJAX): Seria necessário lógica específica por tela. 
                        // O reload é aceitável para um painel administrativo local.
                    }

                } catch (e) {
                    console.error("Erro no heartbeat:", e);
                }
            }

            // Inicia apenas se não estivermos em páginas de edição (para não perder dados digitados)
            // Verifica se a URL não contém 'editar' ou 'novo'
            if (!window.location.href.includes('editar') && !window.location.href.includes('novo')) {
                timer = setInterval(verificarAtualizacoes, INTERVALO_CHECK);
            }
        })();
    </script>
    {% endif %}
</body>
</html>


