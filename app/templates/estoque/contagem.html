<!-- Modal de Confirma√ß√£o de Duplicidade -->
<div id="modal-duplicidade" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 hidden">
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full border-4 border-red-600 flex flex-col items-center">
        <div class="flex items-center gap-3 mb-4">
            <span class="text-red-600 text-3xl">&#9888;</span>
            <span class="text-xl font-bold text-red-700">Produto j√° contado!</span>
        </div>
        <p class="text-gray-800 text-center mb-6 font-semibold">Este produto j√° possui uma contagem registrada neste local.<br>Deseja realmente inserir uma <span class="text-red-600 font-bold">nova quantidade</span>?</p>
        <div class="flex gap-4 w-full justify-center">
            <button id="btn-duplicidade-confirmar" class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-2 rounded shadow">Confirmar nova contagem</button>
            <button id="btn-duplicidade-cancelar" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold px-6 py-2 rounded shadow">Cancelar</button>
        </div>
    </div>
</div>
{% extends "base.html" %}

{% block title %}Contagem - {{ local.nome }}{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[9999] flex items-center justify-center">
    <div class="text-center">
        <div class="animate-spin rounded-full h-20 w-20 border-4 border-amber-500 border-t-transparent mx-auto mb-4"></div>
        <p class="text-white text-2xl font-bold">CARREGANDO...</p>
        <p class="text-gray-400 text-sm mt-2">Aguarde enquanto atualizamos a p√°gina</p>
    </div>
</div>

<!-- Barra de Status (Offline/Sync) -->
<div id="statusBar" class="fixed top-0 left-0 right-0 z-50 h-10 bg-green-600 text-white text-center text-sm font-semibold px-4 py-2 transition-all duration-300 hidden">
  <span id="statusText">Tudo OK</span>
</div>

<div class="sticky top-10 z-40 bg-slate-900 border-b border-slate-700 p-4">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
        
        <div class="flex items-center gap-4">
            <a href="{{ url_for('estoque.setor', setor_id=local.id_setor) }}" 
               class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-gray-300 hover:text-white px-4 py-2 rounded-lg transition-colors border border-slate-700 text-sm font-medium">
                <span>‚Üê</span>
                <span class="hidden sm:inline">Voltar</span>
            </a>

            <h1 class="text-2xl font-bold text-amber-500 truncate">
                {{ local.nome }}
            </h1>
        </div>

        <form method="POST" action="{{ url_for('estoque.finalizar_local', local_id=local.id) }}" class="inline" onsubmit="return confirm('Tem certeza que deseja finalizar este local? Isso indica que tudo aqui foi contado.');">
            <button type="submit" 
                    class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold px-4 py-2 sm:px-6 sm:py-2 rounded-lg transition-colors text-sm sm:text-base shadow-lg shadow-emerald-900/20 flex items-center gap-2">
                <span>‚úì</span>
                <span class="hidden sm:inline">Finalizar Local</span>
                <span class="sm:hidden">Finalizar</span>
            </button>
        </form>
    </div>
</div>

<div class="max-w-4xl mx-auto p-4 pb-8 pt-20">
    <!-- √Årea de Input (Sticky abaixo do header) -->
    <div class="sticky top-24 z-30 bg-slate-900 py-4 mb-4">
        
        <!-- Toggle de Modo (Busca vs Lista) -->
        <div class="mb-4 flex items-center justify-between bg-slate-800 rounded-lg p-3 border border-slate-700">
            <div class="flex items-center gap-3">
                <span class="text-gray-400 text-sm font-semibold">Modo de Contagem:</span>
                <div class="flex bg-slate-700 rounded-lg p-1" id="toggle-container">
                    <button type="button" 
                            id="btn-modo-busca"
                            onclick="alternarModo('busca')"
                            class="px-4 py-2 rounded-md text-sm font-semibold transition-colors bg-amber-500 text-slate-900">
                        üîç Busca
                    </button>
                    <button type="button" 
                            id="btn-modo-lista"
                            onclick="alternarModo('lista')"
                            class="px-4 py-2 rounded-md text-sm font-semibold transition-colors text-gray-300 hover:text-white">
                        üìã Lista
                    </button>
                </div>
            </div>
            <span id="contador-produtos" class="text-sm text-gray-400 hidden">
                <!-- Ser√° preenchido via JS -->
            </span>
        </div>

        <!-- MODO BUSCA -->
        <div id="area-busca" class="block">
            <div class="flex gap-2 mb-2">
                <div class="flex-1 relative">
                    <input type="text" 
                           id="busca-produto" 
                           autofocus
                           placeholder="Bipe o c√≥digo ou digite o nome..." 
                           class="w-full text-lg p-4 pr-12 bg-slate-800 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <button type="button" 
                            id="btn-limpar-busca"
                            onclick="limparBusca()"
                            title="Limpar busca"
                            class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-white hover:bg-slate-700 rounded-lg transition-colors hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <button type="button" 
                        onclick="abrirTecladoAlfabetico()"
                        title="Buscar por nome (teclado)"
                        class="p-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="2" y="4" width="20" height="16" rx="2" ry="2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></rect>
                            <path d="M6 8h.001M10 8h.001M14 8h.001M18 8h.001M6 12h.001M10 12h.001M14 12h.001M18 12h.001M7 16h10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                </button>
                <button type="button" 
                        onclick="abrirModalOcorrencia()"
                        title="Registrar item n√£o cadastrado"
                        class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition-colors flex items-center gap-2">
                    <span>‚ö†Ô∏è</span>
                    <span class="hidden sm:inline text-sm">N√£o Cadastrado</span>
                </button>
            </div>
            
            <!-- Lista de Resultados de Busca -->
            <div id="resultados-busca" class="mt-2 bg-slate-800 rounded-lg max-h-64 overflow-y-auto hidden relative z-[60]">
                <!-- Resultados aparecer√£o aqui via JS -->
            </div>
        </div>

        <!-- MODO LISTA -->
        <div id="area-lista" class="hidden">
            <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                <!-- Header -->
                <div class="bg-slate-700 px-4 py-3 flex items-center justify-between border-b border-slate-600">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        üìã Produtos para Contar
                        <span id="badge-contados" class="bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                            0
                        </span>
                        <span class="text-gray-400 text-sm font-normal">/</span>
                        <span id="badge-total" class="bg-slate-600 text-gray-300 text-xs font-bold px-2 py-1 rounded-full">
                            0
                        </span>
                    </h3>
                    <button type="button" 
                            onclick="toggleListaProdutos()"
                            id="btn-toggle-lista"
                            title="Minimizar lista"
                            class="text-gray-300 hover:text-white transition-colors text-2xl font-bold leading-none">
                        ‚úï
                    </button>
                </div>

                <!-- Lista de Produtos -->
                <div id="lista-produtos-contar" class="max-h-96 overflow-y-auto divide-y divide-slate-700">
                    <!-- Ser√° preenchido via JS -->
                </div>

                <!-- Mensagem quando lista vazia -->
                <div id="mensagem-lista-vazia" class="hidden p-8 text-center">
                    <div class="text-5xl mb-3">‚úÖ</div>
                    <h3 class="text-xl font-bold text-emerald-400 mb-2">Todos os produtos contados!</h3>
                    <p class="text-gray-400 text-sm">Voc√™ pode finalizar este local agora.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de J√° Contados -->
    <div class="mb-6">
        <h2 class="text-xl font-semibold text-gray-100 mb-4">J√° Contados</h2>
        <div class="bg-slate-800 rounded-lg overflow-x-auto overflow-y-auto">
            <table class="w-full min-w-[600px]">
                <thead class="bg-slate-700">
                    <tr>
                        <th class="text-left p-3 text-gray-300">Produto</th>
                        <th class="text-left p-3 text-gray-300">Quantidade</th>
                        <th class="text-left p-3 text-gray-300">Unidade</th>
                        <th class="text-center p-3 text-gray-300">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabela-historico">
                    {% for item in historico %}
                    <tr class="border-t border-slate-700 hover:bg-slate-700/50" data-contagem-id="{{ item.id }}">
                        <td class="p-3 text-gray-100">{{ item.produto_nome }}</td>
                        <td class="p-3 text-gray-100">{{ item.quantidade }}</td>
                        <td class="p-3 text-gray-100">{{ item.unidade_sigla }}</td>
                        <td class="p-3 text-center">
                            <button onclick="excluirItem({{ item.id }})" 
                                    class="text-rose-500 hover:text-rose-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not historico %}
            <div class="p-8 text-center text-gray-400">
                Nenhum item contado ainda.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal-contagem" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full shadow-2xl max-h-[95vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h2 id="modal-produto-nome" class="text-2xl font-bold text-amber-500"></h2>
            {% if session.get('is_gerente') or session.get('funcao') == 'Estoquista Chefe' %}
            <button type="button" id="btn-editor-rapido" onclick="editarProdutoAtualAoModal()" title="Editar Produto Completo" class="text-gray-300 hover:text-white ml-2">‚öôÔ∏è</button>
            {% endif %}
        </div>

        <form id="form-contagem" class="space-y-4">
            <input type="hidden" id="modal-produto-id">
            <input type="hidden" id="modal-local-id" value="{{ local.id }}">
            <!-- Select Unidade -->
            <div>
                <label for="modal-unidade" class="block text-gray-300 mb-2">Unidade</label>
                <select id="modal-unidade" 
                        required
                        class="w-full text-lg p-4 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </select>
            </div>
            <!-- Input Quantidade (readonly para usar apenas teclado customizado) -->
            <div>
                <label for="modal-quantidade" class="block text-gray-300 mb-2">Quantidade</label>
                <input type="text" 
                       id="modal-quantidade" 
                       readonly
                       required
                       placeholder="Use o teclado abaixo"
                       class="w-full text-3xl p-4 bg-slate-700 text-gray-100 rounded-lg text-center font-bold cursor-default focus:outline-none focus:ring-2 focus:ring-amber-500">
                <p id="equivalencia-info" class="text-xs text-gray-400 mt-1 hidden"></p>
            </div>
            
            <!-- Teclado Num√©rico Customizado -->
            <div id="teclado-numerico" class="bg-slate-700/50 rounded-lg p-3">
                <div class="grid grid-cols-3 gap-2">
                    <!-- Linha 1: 7 8 9 -->
                    <button type="button" onclick="digitarNumero('7')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">7</button>
                    <button type="button" onclick="digitarNumero('8')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">8</button>
                    <button type="button" onclick="digitarNumero('9')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">9</button>
                    
                    <!-- Linha 2: 4 5 6 -->
                    <button type="button" onclick="digitarNumero('4')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">4</button>
                    <button type="button" onclick="digitarNumero('5')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">5</button>
                    <button type="button" onclick="digitarNumero('6')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">6</button>
                    
                    <!-- Linha 3: 1 2 3 -->
                    <button type="button" onclick="digitarNumero('1')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">1</button>
                    <button type="button" onclick="digitarNumero('2')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">2</button>
                    <button type="button" onclick="digitarNumero('3')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">3</button>
                    
                    <!-- Linha 4: . 0 ‚Üê -->
                    <button type="button" id="btn-decimal" onclick="digitarNumero('.')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">.</button>
                    <button type="button" onclick="digitarNumero('0')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">0</button>
                    <button type="button" onclick="apagarDigito()" class="bg-red-600 hover:bg-red-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-red-400">‚Üê</button>
                </div>
                
                <!-- Bot√£o Limpar (linha completa) -->
                <button type="button" onclick="limparQuantidade()" class="w-full mt-2 bg-orange-600 hover:bg-orange-500 text-white text-lg font-bold py-3 rounded-lg transition-colors active:bg-orange-400">
                    LIMPAR
                </button>
            </div>
            
            
            
            <!-- Bot√µes -->
            <div class="flex gap-3 mt-6">
                <button type="button" 
                        onclick="fecharModal()"
                        class="flex-1 bg-slate-700 hover:bg-slate-600 text-gray-100 font-semibold py-3 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                        class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-lg transition-colors text-lg">
                    SALVAR
                </button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL DE TECLADO ALFAB√âTICO -->
<div id="modal-teclado-alfabetico" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
    <div class="bg-slate-800 rounded-xl p-6 w-full mx-auto shadow-2xl max-h-[90vh] overflow-y-auto" style="max-width: 600px;">
        <h3 class="text-xl font-bold text-amber-500 mb-4 text-center">Buscar por Nome</h3>
        
        <!-- Campo de Busca Interno -->
        <div class="mb-4">
            <input type="text" 
                   id="busca-modal-interno" 
                   readonly
                   placeholder="Digite usando o teclado abaixo..." 
                   class="w-full text-lg p-4 bg-slate-700 text-gray-100 rounded-lg border-2 border-amber-500/50 focus:border-amber-500 outline-none">
        </div>
        
        <!-- √Årea de Resultados (aparece conforme digita) -->
        <div id="resultados-modal-interno" class="hidden mb-4 bg-slate-700 rounded-lg max-h-48 overflow-y-auto">
            <!-- Resultados aparecer√£o aqui via JS -->
        </div>
        
        <!-- Teclado Alfab√©tico -->
        <div class="bg-slate-700/50 rounded-lg p-3 mb-4">
            <!-- Linha 1: Q-P -->
            <div class="grid grid-cols-10 gap-1 mb-1">
                <button type="button" onclick="digitarLetra('Q')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">Q</button>
                <button type="button" onclick="digitarLetra('W')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">W</button>
                <button type="button" onclick="digitarLetra('E')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">E</button>
                <button type="button" onclick="digitarLetra('R')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">R</button>
                <button type="button" onclick="digitarLetra('T')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">T</button>
                <button type="button" onclick="digitarLetra('Y')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">Y</button>
                <button type="button" onclick="digitarLetra('U')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">U</button>
                <button type="button" onclick="digitarLetra('I')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">I</button>
                <button type="button" onclick="digitarLetra('O')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">O</button>
                <button type="button" onclick="digitarLetra('P')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">P</button>
            </div>
            
            <!-- Linha 2: A-L -->
            <div class="grid grid-cols-9 gap-1 mb-1 px-4">
                <button type="button" onclick="digitarLetra('A')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">A</button>
                <button type="button" onclick="digitarLetra('S')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">S</button>
                <button type="button" onclick="digitarLetra('D')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">D</button>
                <button type="button" onclick="digitarLetra('F')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">F</button>
                <button type="button" onclick="digitarLetra('G')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">G</button>
                <button type="button" onclick="digitarLetra('H')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">H</button>
                <button type="button" onclick="digitarLetra('J')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">J</button>
                <button type="button" onclick="digitarLetra('K')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">K</button>
                <button type="button" onclick="digitarLetra('L')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">L</button>
            </div>
            
            <!-- Linha 3: Z-M + Backspace -->
            <div class="grid grid-cols-9 gap-1 mb-1 px-8">
                <button type="button" onclick="digitarLetra('Z')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">Z</button>
                <button type="button" onclick="digitarLetra('X')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">X</button>
                <button type="button" onclick="digitarLetra('C')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">C</button>
                <button type="button" onclick="digitarLetra('V')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">V</button>
                <button type="button" onclick="digitarLetra('B')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">B</button>
                <button type="button" onclick="digitarLetra('N')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">N</button>
                <button type="button" onclick="digitarLetra('M')" class="bg-slate-600 hover:bg-slate-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-slate-400">M</button>
                <button type="button" onclick="apagarLetra()" class="col-span-2 bg-red-600 hover:bg-red-500 text-white text-xl font-bold py-3 rounded transition-colors active:bg-red-400">‚Üê</button>
            </div>
            
            <!-- Linha 4: Espa√ßo -->
            <div class="grid grid-cols-1 gap-1">
                <button type="button" onclick="digitarLetra(' ')" class="bg-slate-600 hover:bg-slate-500 text-white text-lg font-bold py-3 rounded transition-colors active:bg-slate-400">ESPA√áO</button>
            </div>
        </div>
        
        <!-- Bot√µes de A√ß√£o -->
        <div class="grid grid-cols-2 gap-3">
            <button type="button" 
                    onclick="limparBuscaDoTeclado()"
                    class="bg-orange-600 hover:bg-orange-500 text-white font-semibold py-3 rounded-lg transition-colors">
                LIMPAR TUDO
            </button>
            <button type="button" 
                    onclick="fecharTecladoAlfabetico()"
                    class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 rounded-lg transition-colors">
                FECHAR
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE OCORR√äNCIA (Item N√£o Cadastrado) -->
<div id="modal-ocorrencia" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-amber-500">‚ö†Ô∏è Item N√£o Cadastrado</h2>
            <button type="button" onclick="fecharModalOcorrencia()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>

        <form id="form-ocorrencia" class="space-y-4">
            <input type="hidden" id="ocorrencia-local-id" value="{{ local.id }}">
            
            <!-- Nome do Produto -->
            <div>
                <label for="ocorrencia-nome" class="block text-gray-300 mb-2">Nome do Produto *</label>
                <input type="text" 
                       id="ocorrencia-nome" 
                       placeholder="Ex: P√£o Franc√™s Especial"
                       required
                       class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            </div>
            
            <!-- Quantidade -->
            <div>
                <label for="ocorrencia-quantidade" class="block text-gray-300 mb-2">Quantidade *</label>
                <input type="text" 
                       id="ocorrencia-quantidade" 
                       readonly
                       placeholder="Toque aqui para digitar..."
                       required
                       class="w-full text-2xl p-4 bg-slate-700 text-gray-100 rounded-lg text-center font-bold cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500">
                
                <!-- Teclado Num√©rico Customizado (aparece no focus) -->
                <div id="teclado-ocorrencia" class="hidden bg-slate-700/50 rounded-lg p-3 mt-3">
                    <div class="grid grid-cols-3 gap-2">
                        <!-- Linha 1: 7, 8, 9 -->
                        <button type="button" onclick="digitarNumeroOcorrencia('7')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">7</button>
                        <button type="button" onclick="digitarNumeroOcorrencia('8')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">8</button>
                        <button type="button" onclick="digitarNumeroOcorrencia('9')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">9</button>
                        
                        <!-- Linha 2: 4, 5, 6 -->
                        <button type="button" onclick="digitarNumeroOcorrencia('4')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">4</button>
                        <button type="button" onclick="digitarNumeroOcorrencia('5')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">5</button>
                        <button type="button" onclick="digitarNumeroOcorrencia('6')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">6</button>
                        
                        <!-- Linha 3: 1, 2, 3 -->
                        <button type="button" onclick="digitarNumeroOcorrencia('1')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">1</button>
                        <button type="button" onclick="digitarNumeroOcorrencia('2')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">2</button>
                        <button type="button" onclick="digitarNumeroOcorrencia('3')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">3</button>
                        
                        <!-- Linha 4: ., 0, ‚Üê -->
                        <button type="button" id="btn-decimal-ocorrencia" onclick="digitarNumeroOcorrencia('.')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">.</button>
                        <button type="button" onclick="digitarNumeroOcorrencia('0')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">0</button>
                        <button type="button" onclick="apagarDigitoOcorrencia()" class="bg-red-600 hover:bg-red-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-red-400">‚Üê</button>
                    </div>
                    
                    <!-- Bot√£o Limpar (linha completa) -->
                    <button type="button" onclick="limparQuantidadeOcorrencia()" class="w-full mt-2 bg-orange-600 hover:bg-orange-500 text-white text-lg font-bold py-3 rounded-lg transition-colors active:bg-orange-400">
                        LIMPAR
                    </button>
                </div>
            </div>
            
            <!-- Unidade de Medida -->
            <div>
                <label for="ocorrencia-unidade" class="block text-gray-300 mb-2">Unidade de Medida *</label>
                <select id="ocorrencia-unidade" 
                        required
                        class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <option value="">Selecione uma unidade...</option>
                </select>
            </div>
            
            <!-- Foto (Condicional: Online/Offline) -->
            <div id="container-foto">
                <label class="block text-gray-300 mb-2">Foto (Opcional)</label>
                <input type="file" 
                       id="ocorrencia-foto" 
                       accept="image/*"
                       capture="environment"
                       class="w-full p-2 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                <p id="foto-status-texto" class="text-xs text-gray-400 mt-1"></p>
            </div>
            
            <!-- Bot√µes -->
            <div class="flex gap-3 mt-6">
                <button type="button" 
                        onclick="fecharModalOcorrencia()"
                        class="flex-1 bg-slate-700 hover:bg-slate-600 text-gray-100 font-semibold py-3 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                        class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-3 rounded-lg transition-colors text-lg">
                    REGISTRAR
                </button>
            </div>
        </form>
    </div>
</div>

{% include 'includes/modal_produto.html' %}
<script src="{{ url_for('static', filename='js/produto_modal.js') }}"></script>

<script>

// ============================================
// OFFLINE-FIRST STORE & FORWARD LOGIC
// ============================================

// Configura√ß√µes
const SERVER_URL = '/salvar_contagem';
const SYNC_INTERVAL = 5000; // 5 segundos
const LOCAL_STORAGE_KEY = 'fila_contagens_' + {{ local.id }};

// Estado
let fila = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
let sincronizandoAtualmente = false;
let servidorInacessivel = false;

// Dados dos produtos para busca
const todosProdutos = {{ produtos | tojson }};
const unidadesData = {{ unidades | tojson }};
const localId = {{ local.id }};
const historico = {{ historico | tojson }};

// Elementos DOM
const statusBar = document.getElementById('statusBar');
const statusText = document.getElementById('statusText');
const inputBusca = document.getElementById('busca-produto');
const resultadosBusca = document.getElementById('resultados-busca');
const modal = document.getElementById('modal-contagem');
const formContagem = document.getElementById('form-contagem');
const modalQuantidade = document.getElementById('modal-quantidade');
const modalUnidade = document.getElementById('modal-unidade');
const tabelaHistorico = document.getElementById('tabela-historico');

// Elementos do toggle de modo
const areaBusca = document.getElementById('area-busca');
const areaLista = document.getElementById('area-lista');
const btnModoBusca = document.getElementById('btn-modo-busca');
const btnModoLista = document.getElementById('btn-modo-lista');
const listaProtudosContar = document.getElementById('lista-produtos-contar');
const contadorProdutos = document.getElementById('contador-produtos');
const badgeContados = document.getElementById('badge-contados');
const badgeTotal = document.getElementById('badge-total');
const mensagemListaVazia = document.getElementById('mensagem-lista-vazia');
const btnToggleLista = document.getElementById('btn-toggle-lista');

// Estado do modo
const LIMITE_MODO_LISTA = 30;
let modoAtual = 'busca'; // 'busca' ou 'lista'
let listaExpandida = true; // Controla se lista est√° aberta ou fechada
const localStorageKeyModo = 'modo_contagem_' + localId;
const localStorageKeyListaExpandida = 'lista_expandida_' + localId;

// ============================================
// FUN√á√ïES DE STATUS
// ============================================

function atualizarStatusBar() {
    if (!navigator.onLine) {
        // Offline
        statusBar.classList.remove('hidden');
        statusBar.className = 'fixed top-0 left-0 right-0 z-50 h-10 bg-red-600 text-white text-center text-sm font-semibold px-4 py-2 transition-all duration-300';
        statusText.textContent = `Sem internet - Salvando no Tablet (${fila.length} pendente${fila.length !== 1 ? 's' : ''})`;
    } else if (sincronizandoAtualmente) {
        // Sincronizando
        statusBar.classList.remove('hidden');
        statusBar.className = 'fixed top-0 left-0 right-0 z-50 h-10 bg-yellow-500 text-slate-900 text-center text-sm font-semibold px-4 py-2 transition-all duration-300';
        statusText.textContent = `Enviando pend√™ncias... (${fila.length} item${fila.length !== 1 ? 'ns' : ''})`;
    } else if (servidorInacessivel) {
        // Servidor inacess√≠vel (internet OK, mas servidor n√£o responde)
        statusBar.classList.remove('hidden');
        statusBar.className = 'fixed top-0 left-0 right-0 z-50 h-10 bg-orange-500 text-white text-center text-sm font-semibold px-4 py-2 transition-all duration-300';
        statusText.textContent = 'Internet OK, mas servidor inacess√≠vel. Verifique o Wi-Fi!';
    } else {
        // Tudo OK
        statusBar.classList.add('hidden');
    }
}

// ============================================
// SALVAR CONTAGEM (COM FALLBACK OFFLINE)
// ============================================

async function salvarContagem(produtoId, quantidade, unidadeId) {
    const contagem = {
        id: Date.now(), // ID tempor√°rio para identificar no localStorage
        produto_id: produtoId,
        local_id: localId,
        quantidade: quantidade,
        unidade_id: unidadeId,
        timestamp: new Date().toISOString(),
        sincronizado: false
    };

    try {
        sincronizandoAtualmente = true;
        atualizarStatusBar();

        const response = await fetch(SERVER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                produto_id: produtoId,
                local_id: localId,
                quantidade: quantidade,
                unidade_id: unidadeId
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.sucesso) {
                sincronizandoAtualmente = false;
                servidorInacessivel = false;
                atualizarStatusBar();
                
                // Sucesso: toca beep e recarrega
                tocarBeep();
                setTimeout(() => window.location.reload(), 500);
                return true;
            }
        }

        // Erro 5xx ou JSON inv√°lido: trata como offline
        throw new Error(`Erro ${response.status}`);

    } catch (error) {
        console.error('Erro ao salvar:', error);

        // Verifica se √© um erro de conectividade (servidor inacess√≠vel)
        if (error instanceof TypeError && error.message.includes('fetch')) {
            // Erro de rede: servidor n√£o encontrado (Wrong Network)
            servidorInacessivel = true;
        }

        // FALLBACK: salva na fila do localStorage
        contagem.sincronizado = false;
        fila.push(contagem);
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(fila));

        sincronizandoAtualmente = false;
        atualizarStatusBar();

        // Feedback: mostra sucesso local
        tocarBeep();
        mostrarToastSucessoLocal();

        // Recarrega a p√°gina para mostrar o item na lista
        setTimeout(() => window.location.reload(), 1000);
        
        return true; // Continua o fluxo mesmo com erro
    }
}

// ============================================
// SINCRONIZADOR (A CADA 5s)
// ============================================

async function sincronizarFila() {
    if (fila.length === 0 || !navigator.onLine || sincronizandoAtualmente || servidorInacessivel) {
        atualizarStatusBar();
        return;
    }

    sincronizandoAtualmente = true;
    atualizarStatusBar();

    const primeiroItem = fila[0];

    try {
        const response = await fetch(SERVER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                produto_id: primeiroItem.produto_id,
                local_id: primeiroItem.local_id,
                quantidade: primeiroItem.quantidade,
                unidade_id: primeiroItem.unidade_id
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.sucesso) {
                // Sucesso: remove da fila
                fila.shift();
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(fila));
                servidorInacessivel = false;
            }
        } else {
            // Erro do servidor: n√£o remove, tenta depois
            throw new Error(`Erro ${response.status}`);
        }
    } catch (error) {
        console.error('Erro ao sincronizar:', error);
        
        // Se √© erro de rede (servidor inacess√≠vel):
        if (error instanceof TypeError || (error.message && error.message.includes('Failed to fetch'))) {
            servidorInacessivel = true;
            // PARA O LOOP de sincroniza√ß√£o para n√£o gastar bateria
            sincronizandoAtualmente = false;
            atualizarStatusBar();
            return;
        }
    }

    sincronizandoAtualmente = false;
    atualizarStatusBar();
}

// Inicia o sincronizador
setInterval(sincronizarFila, SYNC_INTERVAL);

// ============================================
// HELPER FUNCTIONS
// ============================================

function tocarBeep() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        // Ignora erro
    }
}

function mostrarToastSucessoLocal() {
    // Feedback visual simples
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-yellow-500 text-slate-900 px-4 py-2 rounded-lg font-semibold z-40';
    toast.textContent = 'Salvo localmente (fila)';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ============================================
// CARREGAMENTO INICIAL: MOSTRAR ITENS EM FILA
// ============================================

function carregarFilaNoHistorico() {
    if (fila.length === 0) return;

    // Adiciona itens da fila ao topo da tabela com √≠cone ‚è≥
    fila.forEach(item => {
        const produto = todosProdutos.find(p => p.id === item.produto_id);
        const unidade = unidadesData.find(u => u.id === item.unidade_id);
        
        if (!produto || !unidade) return;

        const row = document.createElement('tr');
        row.className = 'border-t border-slate-700 hover:bg-slate-700/50 bg-yellow-900/20';
        row.dataset.filaId = item.id;
        row.innerHTML = `
            <td class="p-3 text-gray-100">
                <span class="mr-2">‚è≥</span>${produto.nome}
            </td>
            <td class="p-3 text-gray-100">${item.quantidade}</td>
            <td class="p-3 text-gray-100">${unidade.sigla}</td>
            <td class="p-3 text-center">
                <button onclick="excluirDaFila(${item.id})" 
                        class="text-rose-500 hover:text-rose-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </td>
        `;
        tabelaHistorico.insertBefore(row, tabelaHistorico.firstChild);
    });
}

function excluirDaFila(filaId) {
    if (!confirm('Remover este item da fila?')) return;
    
    fila = fila.filter(item => item.id !== filaId);
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(fila));
    
    const row = document.querySelector(`[data-fila-id="${filaId}"]`);
    if (row) row.remove();
    
    atualizarStatusBar();
}

// Carrega fila ao iniciar
carregarFilaNoHistorico();
atualizarStatusBar();

// Listeners de conectividade
window.addEventListener('online', () => {
    servidorInacessivel = false;
    atualizarStatusBar();
    sincronizarFila(); // Tenta sincronizar imediatamente
});

window.addEventListener('offline', () => {
    atualizarStatusBar();
});

// ============================================
// MODO LISTA: TOGGLE E FUNCIONALIDADES
// ============================================

/**
 * Verifica se o modo lista pode ser habilitado (< 30 produtos)
 */
function modoListaDisponivel() {
    return todosProdutos.length < LIMITE_MODO_LISTA;
}

/**
 * Inicializa o modo de contagem
 */
function inicializarModo() {
    // Verifica se modo lista est√° dispon√≠vel
    if (!modoListaDisponivel()) {
        // Desabilita modo lista
        btnModoLista.disabled = true;
        btnModoLista.classList.add('opacity-50', 'cursor-not-allowed');
        btnModoLista.title = `Modo lista dispon√≠vel apenas para categorias com menos de ${LIMITE_MODO_LISTA} produtos (atual: ${todosProdutos.length})`;
        
        // For√ßa modo busca
        modoAtual = 'busca';
    } else {
        // Recupera prefer√™ncia salva
        const modoSalvo = localStorage.getItem(localStorageKeyModo);
        if (modoSalvo === 'lista' || modoSalvo === 'busca') {
            modoAtual = modoSalvo;
        }
        
    }
    
    // Aplica modo inicial
    aplicarModo();
}

/**
 * Alterna entre modo busca e modo lista
 */
function alternarModo(novoModo) {
    if (novoModo === 'lista' && !modoListaDisponivel()) {
        return; // N√£o permite trocar se n√£o dispon√≠vel
    }
    
    modoAtual = novoModo;
    localStorage.setItem(localStorageKeyModo, novoModo);
    aplicarModo();
}

/**
 * Aplica o modo visual na interface
 */
function aplicarModo() {
    if (modoAtual === 'busca') {
        // Modo Busca
        areaBusca.classList.remove('hidden');
        areaLista.classList.add('hidden');
        
        btnModoBusca.classList.add('bg-amber-500', 'text-slate-900');
        btnModoBusca.classList.remove('text-gray-300', 'hover:text-white');
        
        btnModoLista.classList.remove('bg-amber-500', 'text-slate-900');
        btnModoLista.classList.add('text-gray-300', 'hover:text-white');
        
        inputBusca.focus();
    } else {
        // Modo Lista
        areaBusca.classList.add('hidden');
        areaLista.classList.remove('hidden');
        
        btnModoLista.classList.add('bg-amber-500', 'text-slate-900');
        btnModoLista.classList.remove('text-gray-300', 'hover:text-white');
        
        btnModoBusca.classList.remove('bg-amber-500', 'text-slate-900');
        btnModoBusca.classList.add('text-gray-300', 'hover:text-white');
        
        // Renderiza lista
        renderizarListaProdutos();
    }
}

/**
 * Renderiza a lista de produtos no modo lista
 */
function renderizarListaProdutos() {
    // Identifica produtos j√° contados
    const produtosContadosIds = historico.map(h => h.id_produto);
    const totalProdutos = todosProdutos.length;
    const totalContados = produtosContadosIds.length;
    
    // Atualiza badges
    badgeContados.textContent = totalContados;
    badgeTotal.textContent = totalProdutos;
    
    // Renderiza TODOS os produtos (contados e n√£o contados)
    listaProtudosContar.innerHTML = todosProdutos.map(produto => {
        const foiContado = produtosContadosIds.includes(produto.id);
        const infoExtras = [];
        if (produto.id_erp) infoExtras.push(`ID: ${produto.id_erp}`);
        if (produto.gtin) infoExtras.push(`GTIN: ${produto.gtin}`);
        
        return `
            <div class="p-4 hover:bg-slate-700/50 transition-colors flex items-center justify-between ${foiContado ? 'bg-emerald-900/20' : ''}">
                <div class="flex-1 flex items-center gap-3">
                    ${foiContado ? '<span class="text-emerald-400 text-xl">‚úì</span>' : ''}
                    <div>
                        <div class="font-semibold ${foiContado ? 'text-emerald-300' : 'text-white'} text-base">${produto.nome}</div>
                        ${infoExtras.length > 0 ? `<div class="text-xs text-gray-500 mt-1">${infoExtras.join(' ‚Ä¢ ')}</div>` : ''}
                    </div>
                </div>
                <button type="button"
                    onclick="abrirModalLista(${produto.id}, '${produto.nome.replace(/'/g, "\\'")}', false)" 
                    class="ml-4 ${foiContado ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white font-bold px-4 py-2 rounded-lg transition-colors flex items-center gap-2 shadow-lg">
                    <span>${foiContado ? 'üìù' : 'üìù'}</span>
                    
                </button>
            </div>
        `;
    }).join('');
    
    // Remove mensagem de lista vazia (n√£o √© mais necess√°ria)
    mensagemListaVazia.classList.add('hidden');
}

/**
 * Abre o modal de contagem a partir da lista de produtos
 */
function abrirModalLista(produtoId, produtoNome) {
    abrirModal(produtoId, produtoNome, false);
}

/**
 * Toggle para expandir/colapsar lista de produtos
 */
function toggleListaProdutos() {
    listaExpandida = !listaExpandida;
    localStorage.setItem(localStorageKeyListaExpandida, listaExpandida);
    aplicarEstadoLista();
}

/**
 * Aplica estado visual da lista (expandida/colapsada)
 */
function aplicarEstadoLista() {
    if (listaExpandida) {
        listaProtudosContar.classList.remove('hidden');
        btnToggleLista.textContent = '‚úï';
        btnToggleLista.title = 'Minimizar lista';
    } else {
        listaProtudosContar.classList.add('hidden');
        btnToggleLista.textContent = '‚ñº';
        btnToggleLista.title = 'Expandir lista';
    }
}

/**
 * Carrega estado salvo da lista
 */
function carregarEstadoLista() {
    const estadoSalvo = localStorage.getItem(localStorageKeyListaExpandida);
    if (estadoSalvo !== null) {
        listaExpandida = estadoSalvo === 'true';
    }
    aplicarEstadoLista();
}

// Inicializa modo ao carregar p√°gina
inicializarModo();
carregarEstadoLista();

// ============================================
// BUSCA E MODAL (ORIGINAL, COM AJUSTES)
// ============================================

/**
 * Realiza a busca de produtos baseado no valor do input
 */
function realizarBusca() {
    const termo = inputBusca.value.toLowerCase().trim();
    
    // Mostra/oculta bot√£o de limpar baseado no conte√∫do
    const btnLimpar = document.getElementById('btn-limpar-busca');
    if (inputBusca.value.length > 0) {
        btnLimpar.classList.remove('hidden');
    } else {
        btnLimpar.classList.add('hidden');
    }
    
    if (termo.length === 0) {
        resultadosBusca.classList.add('hidden');
        return;
    }
    
    const resultados = todosProdutos.filter(produto => {
        const nome = produto.nome.toLowerCase();
        const gtin = String(produto.gtin || '').toLowerCase();
        const erp = String(produto.id_erp || '').toLowerCase();
        
        // Verifica se o termo digitado est√° em QUALQUER um dos campos
        return nome.includes(termo) || 
               gtin.includes(termo) || 
               erp.includes(termo);
        
    });
    
    if (resultados.length === 0) {
        resultadosBusca.innerHTML = '<div class="p-4 text-gray-400 text-center">Nenhum produto encontrado</div>';
        resultadosBusca.classList.remove('hidden');
        return;
    }
    
    resultadosBusca.innerHTML = resultados.map(produto => `
        <button onclick="abrirModal(${produto.id}, '${produto.nome.replace(/'/g, "\\'")}', false)" 
                class="w-full text-left p-4 hover:bg-slate-700 transition-colors border-b border-slate-700 last:border-0">
            <div class="font-semibold text-gray-100">${produto.nome}</div>
        </button>
    `).join('');
    
    resultadosBusca.classList.remove('hidden');
}

// Busca de produtos
inputBusca.addEventListener('input', realizarBusca);

/**
 * Limpa o campo de busca e retorna o foco para ele
 */
function limparBusca() {
    inputBusca.value = '';
    inputBusca.focus();
    resultadosBusca.classList.add('hidden');
    document.getElementById('btn-limpar-busca').classList.add('hidden');
}

// =========================
// TECLADO ALFAB√âTICO
// =========================

const inputBuscaModalInterno = document.getElementById('busca-modal-interno');
const resultadosModalInterno = document.getElementById('resultados-modal-interno');

/**
 * Abre o modal do teclado alfab√©tico
 */
function abrirTecladoAlfabetico() {
    const modalTeclado = document.getElementById('modal-teclado-alfabetico');
    modalTeclado.classList.remove('hidden');
    inputBuscaModalInterno.value = ''; // Limpa o campo interno
    resultadosModalInterno.classList.add('hidden'); // Esconde resultados
    resultadosModalInterno.innerHTML = ''; // Limpa conte√∫do
}

/**
 * Fecha o modal do teclado alfab√©tico
 */
function fecharTecladoAlfabetico() {
    const modalTeclado = document.getElementById('modal-teclado-alfabetico');
    modalTeclado.classList.add('hidden');
}

/**
 * Digita uma letra no campo de busca interno do modal
 */
function digitarLetra(letra) {
    inputBuscaModalInterno.value += letra;
    realizarBuscaNoModal();
}

/**
 * Remove a √∫ltima letra (backspace)
 */
function apagarLetra() {
    inputBuscaModalInterno.value = inputBuscaModalInterno.value.slice(0, -1);
    realizarBuscaNoModal();
}

/**
 * Limpa completamente a busca do teclado alfab√©tico
 */
function limparBuscaDoTeclado() {
    inputBuscaModalInterno.value = '';
    resultadosModalInterno.classList.add('hidden');
    resultadosModalInterno.innerHTML = '';
}

/**
 * Realiza a busca dentro do modal e exibe os resultados
 */
function realizarBuscaNoModal() {
    const termo = inputBuscaModalInterno.value.toLowerCase().trim();
    
    if (termo.length === 0) {
        resultadosModalInterno.classList.add('hidden');
        resultadosModalInterno.innerHTML = '';
        return;
    }
    
    const resultados = todosProdutos.filter(produto => {
        const nome = produto.nome.toLowerCase();
        const gtin = String(produto.gtin || '').toLowerCase();
        const erp = String(produto.id_erp || '').toLowerCase();
        
        return nome.includes(termo) || 
               gtin.includes(termo) || 
               erp.includes(termo);
    });
    
    if (resultados.length === 0) {
        resultadosModalInterno.innerHTML = '<div class="p-4 text-gray-400 text-center">Nenhum produto encontrado</div>';
        resultadosModalInterno.classList.remove('hidden');
        return;
    }
    
    resultadosModalInterno.innerHTML = resultados.map(produto => `
        <button onclick="selecionarProdutoDoModal(${produto.id}, '${produto.nome.replace(/'/g, "\\'")}')" 
                class="w-full text-left p-4 hover:bg-slate-600 transition-colors border-b border-slate-600 last:border-0">
            <div class="font-semibold text-gray-100">${produto.nome}</div>
        </button>
    `).join('');
    
    resultadosModalInterno.classList.remove('hidden');
}

/**
 * Seleciona um produto da lista do modal e abre o modal de contagem
 */
function selecionarProdutoDoModal(produtoId, produtoNome) {
    fecharTecladoAlfabetico();
    abrirModal(produtoId, produtoNome, false);
}

// Fechar busca ao clicar fora
document.addEventListener('click', function(e) {
    if (!inputBusca.contains(e.target) && !resultadosBusca.contains(e.target)) {
        resultadosBusca.classList.add('hidden');
    }
});

// Abrir modal
function abrirModal(produtoId, produtoNome, ignorarDuplicidade) {   
    // Verifica√ß√£o de duplicidade: produto j√° contado neste local?
    const produto = todosProdutos.find(p => p.id === produtoId);
    if (!produto) return;

    // Checa se produto j√° est√° no historico ou na fila offline
    if (!ignorarDuplicidade) {
        const jaContadoHistorico = historico.some(item => (item.produto_id === produtoId) || (item.id_produto === produtoId));
        const jaContadoFila = fila.some(item => item.produto_id === produtoId);
        if (jaContadoHistorico || jaContadoFila) {
            window._abrirModalDuplicidade = () => {
                document.getElementById('btn-duplicidade-confirmar').onclick = null;
                document.getElementById('btn-duplicidade-cancelar').onclick = null;
                document.getElementById('btn-duplicidade-confirmar').onclick = () => {
                    document.getElementById('modal-duplicidade').classList.add('hidden');
                    window._abrirModalDuplicidade = null;
                    abrirModal(produtoId, produtoNome, true);
                };
                document.getElementById('btn-duplicidade-cancelar').onclick = () => {
                    document.getElementById('modal-duplicidade').classList.add('hidden');
                    resultadosBusca.classList.add('hidden');
                    inputBusca.value = '';
                    window._abrirModalDuplicidade = null;
                };
            };
            document.getElementById('modal-duplicidade').classList.remove('hidden');
            if (window._abrirModalDuplicidade) window._abrirModalDuplicidade();
            return;
        }
    }

    document.getElementById('modal-produto-id').value = produtoId;
    document.getElementById('modal-produto-nome').textContent = produtoNome;
    modalQuantidade.value = '';

    // Limpa op√ß√µes atuais de unidade
    modalUnidade.innerHTML = '';

    const unidadesPermitidas = produto.unidades_permitidas || [];
    const baseUnitId = produto.id_unidade_padrao;

    let listaUnidades = unidadesPermitidas;
    if (!listaUnidades.length) {
        // Fallback: se n√£o houver cadastro, usa todas as unidades com fator 1
        listaUnidades = unidadesData.map(u => ({
            id: u.id,
            sigla: u.sigla,
            nome: u.nome,
            fator_conversao: 1,
            permite_decimal: u.permite_decimal,
        }));
    }

    listaUnidades.forEach(uPerm => {
        const unidadeInfo = unidadesData.find(u => u.id === (uPerm.id || uPerm.id_unidade) );
        if (!unidadeInfo) return;
        const option = document.createElement('option');
        const unidadeId = uPerm.id || uPerm.id_unidade;
        option.value = unidadeId;
        option.textContent = `${unidadeInfo.sigla} - ${unidadeInfo.nome}`;
        option.dataset.decimal = unidadeInfo.permite_decimal ? 'true' : 'false';
        option.dataset.fator = uPerm.fator_conversao || uPerm.fator || 1;
        modalUnidade.appendChild(option);
    });

    // Seleciona unidade padr√£o se estiver na lista
    if (baseUnitId) {
        for (let i = 0; i < modalUnidade.options.length; i++) {
            if (parseInt(modalUnidade.options[i].value) === baseUnitId) {
                modalUnidade.selectedIndex = i;
                break;
            }
        }
    }

    // Prepara o modal (editor r√°pido movido para modal reutiliz√°vel)

    // Ajusta bot√£o decimal baseado na unidade selecionada
    modalUnidade.dispatchEvent(new Event('change'));

    modal.classList.remove('hidden');
    resultadosBusca.classList.add('hidden');
    inputBusca.value = '';
}

// =========================
// TECLADO NUM√âRICO CUSTOMIZADO
// =========================

/**
 * Digita um n√∫mero ou ponto decimal no input de quantidade
 */
function digitarNumero(digito) {
    const input = document.getElementById('modal-quantidade');
    const valorAtual = input.value;
    
    // Valida√ß√£o: n√£o permite mais de um ponto decimal
    if (digito === '.' && valorAtual.includes('.')) {
        return;
    }
    
    // Valida√ß√£o: n√£o permite ponto decimal se unidade n√£o permitir
    const option = modalUnidade.options[modalUnidade.selectedIndex];
    const permiteDecimal = option.getAttribute('data-decimal') === 'true';
    if (digito === '.' && !permiteDecimal) {
        return;
    }
    
    // Adiciona o d√≠gito
    input.value = valorAtual + digito;
    
    // Atualiza equival√™ncia
    atualizarEquivalencia();
}

/**
 * Remove o √∫ltimo d√≠gito (backspace)
 */
function apagarDigito() {
    const input = document.getElementById('modal-quantidade');
    input.value = input.value.slice(0, -1);
    atualizarEquivalencia();
}

/**
 * Limpa completamente o input de quantidade
 */
function limparQuantidade() {
    document.getElementById('modal-quantidade').value = '';
    atualizarEquivalencia();
}

// Fechar modal
function fecharModal() {
    modal.classList.add('hidden');
    inputBusca.focus();
}

// Atualiza equival√™ncia visual
function atualizarEquivalencia() {
    const info = document.getElementById('equivalencia-info');
    const quantidade = parseFloat(modalQuantidade.value);
    const option = modalUnidade.options[modalUnidade.selectedIndex];
    if (!option || !quantidade || quantidade <= 0) {
        info.classList.add('hidden');
        info.textContent = '';
        return;
    }
    const fator = parseFloat(option.dataset.fator || '1');
    const total = quantidade * fator;
    
    const produtoId = parseInt(document.getElementById('modal-produto-id').value);
    const produto = todosProdutos.find(p => p.id === produtoId);
    let unidadeBaseSigla = '';
    if (produto) {
        const base = unidadesData.find(u => u.id === produto.id_unidade_padrao);
        unidadeBaseSigla = base ? base.sigla : '';
    }
    
    info.textContent = `Equivalente a ${total.toFixed(2)} ${unidadeBaseSigla}`;
    info.classList.remove('hidden');
}

// Mudan√ßa de unidade - ajusta bot√£o decimal e limpa valor se necess√°rio
modalUnidade.addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    const permiteDecimal = option.getAttribute('data-decimal') === 'true';
    
    // Habilita/desabilita bot√£o decimal
    const btnDecimal = document.getElementById('btn-decimal');
    if (permiteDecimal) {
        btnDecimal.disabled = false;
        btnDecimal.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        btnDecimal.disabled = true;
        btnDecimal.classList.add('opacity-50', 'cursor-not-allowed');
        
        // Se mudou para unidade que n√£o permite decimal, remove ponto decimal do valor atual
        if (modalQuantidade.value && modalQuantidade.value.includes('.')) {
            modalQuantidade.value = Math.floor(parseFloat(modalQuantidade.value) || 0).toString();
        }
    }
    
    atualizarEquivalencia();
});

modalQuantidade.addEventListener('input', atualizarEquivalencia);

// Salvar contagem (integrado com offline)
formContagem.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const produtoId = parseInt(document.getElementById('modal-produto-id').value);
    const quantidadeTexto = modalQuantidade.value.trim();
    
    // Valida√ß√£o de quantidade vazia
    if (!quantidadeTexto) {
        alert('Por favor, insira uma quantidade.');
        return;
    }
    
    const quantidade = parseFloat(quantidadeTexto);
    const unidadeId = parseInt(modalUnidade.value);
    
    // Valida√ß√£o de quantidade inv√°lida ou zero
    if (isNaN(quantidade) || quantidade <= 0) {
        alert('Por favor, insira uma quantidade v√°lida maior que zero.');
        return;
    }
    
    await salvarContagem(produtoId, quantidade, unidadeId);
    
    // Nota: ap√≥s salvar, a p√°gina recarrega automaticamente no salvarContagem()
    // ent√£o n√£o precisa atualizar manualmente aqui
});

// =========================
// Handler para Modal de Produto Reutiliz√°vel
// =========================

/**
 * Fun√ß√£o chamada ao clicar no bot√£o ‚öôÔ∏è
 * Abre o modal de edi√ß√£o de produto completo
 */
function editarProdutoAtualAoModal() {
    const produtoId = parseInt(document.getElementById('modal-produto-id').value);
    if (!produtoId) return;
    
    // Fecha o modal de contagem
    fecharModal();
    
    // Abre o modal de produto (reutiliz√°vel)
    editarProduto(produtoId);
}

/**
 * Intercepta o envio do formul√°rio do modal de produto
 * para enviar via AJAX e recarregar os dados do produto em contagem.html
 */
document.addEventListener('DOMContentLoaded', function() {
    const formProduto = document.getElementById('formProduto');
    if (formProduto) {
        formProduto.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Coleta dados do formul√°rio
            const formData = new FormData(this);
            
            // Envia via AJAX com header X-Requested-With
            fetch('{{ url_for("admin.admin_produtos") }}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.sucesso) {
                    // Sucesso: fecha modal, mostra toast
                    fecharModalProduto(); // Fecha o modal de produto
                    mostrarToastSucessoLocal();
                    
                    // CR√çTICO: recarrega os dados do produto atual
                    const produtoId = parseInt(document.getElementById('modal-produto-id').value);
                    if (produtoId) {
                        atualizarUnidadesProdutoContagem(produtoId);
                    }
                } else {
                    alert(data.error || 'Erro ao salvar produto.');
                }
            })
            .catch(error => {
                console.error('Erro ao salvar:', error);
                alert('Erro ao conectar com o servidor.');
            });
        });
    }
});

/**
 * Recarrega as unidades de um produto e atualiza o select de unidades
 * no modal de contagem sem recarregar a p√°gina inteira
 */
async function atualizarUnidadesProdutoContagem(produtoId) {
    try {
        // Busca dados atualizados do produto
        const response = await fetch(`/admin/produto/${produtoId}`);
        if (!response.ok) throw new Error('Erro ao buscar produto');
        
        const produto = await response.json();
        
        // Atualiza os dados em memoria
        const produtoGlobal = todosProdutos.find(p => p.id === produtoId);
        if (produtoGlobal) {
            produtoGlobal.unidades_permitidas = produto.unidades_permitidas;
            produtoGlobal.id_unidade_padrao = produto.id_unidade_padrao;
        }
        
        // Reconstr√≥i o select de unidades com dados atualizados
        const listaUnidades = produto.unidades_permitidas || [];
        const baseUnitId = produto.id_unidade_padrao;
        
        let unidadesParaMostrar = listaUnidades;
        if (!unidadesParaMostrar.length) {
            unidadesParaMostrar = unidadesData.map(u => ({
                id: u.id,
                sigla: u.sigla,
                nome: u.nome,
                fator_conversao: 1,
                permite_decimal: u.permite_decimal,
            }));
        }
        
        // Limpa o select e reconstr√≥i
        modalUnidade.innerHTML = '';
        unidadesParaMostrar.forEach(uPerm => {
            const unidadeInfo = unidadesData.find(u => u.id === (uPerm.id || uPerm.id_unidade));
            if (!unidadeInfo) return;
            
            const option = document.createElement('option');
            const unidadeId = uPerm.id || uPerm.id_unidade;
            option.value = unidadeId;
            option.textContent = `${unidadeInfo.sigla} - ${unidadeInfo.nome}`;
            option.dataset.decimal = unidadeInfo.permite_decimal ? 'true' : 'false';
            option.dataset.fator = uPerm.fator_conversao || uPerm.fator || 1;
            modalUnidade.appendChild(option);
        });
        
        // Seleciona a unidade padr√£o
        if (baseUnitId) {
            for (let i = 0; i < modalUnidade.options.length; i++) {
                if (parseInt(modalUnidade.options[i].value) === baseUnitId) {
                    modalUnidade.selectedIndex = i;
                    break;
                }
            }
        }
        
        // Atualiza eventos de mudan√ßa
        modalUnidade.dispatchEvent(new Event('change'));
        
    } catch (error) {
        console.error('Erro ao atualizar unidades:', error);
    }
}

// =========================
// Editor R√°pido: JS helpers (MANTIDO PARA COMPATIBILIDADE)
// =========================


// Excluir item do hist√≥rico
async function excluirItem(contagemId) {
    if (!confirm('Deseja realmente excluir este item?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/excluir_item/${contagemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.sucesso) {
            // Remove a linha da tabela
            const linha = document.querySelector(`[data-contagem-id="${contagemId}"]`);
            if (linha) {
                linha.remove();
            }
            
            // Se n√£o h√° mais itens, mostra mensagem
            const tbody = document.getElementById('tabela-historico');
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400">Nenhum item contado ainda.</td></tr>';
            }
        } else {
            alert(data.erro || 'Erro ao excluir item.');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir item. Tente novamente.');
    }
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        fecharModal();
    }
});

// =========================
// OCORR√äNCIAS (Itens N√£o Cadastrados)
// =========================

const modalOcorrencia = document.getElementById('modal-ocorrencia');
const formOcorrencia = document.getElementById('form-ocorrencia');
const containerFoto = document.getElementById('container-foto');
const fotoStatusTexto = document.getElementById('foto-status-texto');
const inputOcorrenciaUnidade = document.getElementById('ocorrencia-unidade');

/**
 * Abre o modal de ocorr√™ncia e popula o select de unidades
 */
function abrirModalOcorrencia() {
    // Popula select de unidades
    inputOcorrenciaUnidade.innerHTML = '<option value="">Selecione uma unidade...</option>';
    unidadesData.forEach(u => {
        const option = document.createElement('option');
        option.value = u.id;
        option.textContent = `${u.sigla} - ${u.nome}`;
        inputOcorrenciaUnidade.appendChild(option);
    });
    
    // Atualiza visibilidade de foto conforme conex√£o
    atualizarFotoOcorrencia();
    
    // Limpa campo de quantidade
    document.getElementById('ocorrencia-quantidade').value = '';
    document.getElementById('teclado-ocorrencia').classList.add('hidden');
    
    // Abre modal
    modalOcorrencia.classList.remove('hidden');
    document.getElementById('ocorrencia-nome').focus();
}

// =========================
// TECLADO NUM√âRICO DA OCORR√äNCIA
// =========================

const inputOcorrenciaQuantidade = document.getElementById('ocorrencia-quantidade');
const tecladoOcorrencia = document.getElementById('teclado-ocorrencia');

/**
 * Mostra o teclado quando o campo de quantidade recebe foco
 */
if (inputOcorrenciaQuantidade) {
    inputOcorrenciaQuantidade.addEventListener('focus', function() {
        tecladoOcorrencia.classList.remove('hidden');
    });
    
    inputOcorrenciaQuantidade.addEventListener('click', function() {
        tecladoOcorrencia.classList.remove('hidden');
    });
}

/**
 * Esconde o teclado quando clica fora do campo e do teclado
 */
document.addEventListener('click', function(e) {
    if (inputOcorrenciaQuantidade && tecladoOcorrencia) {
        const dentroDoInput = inputOcorrenciaQuantidade.contains(e.target);
        const dentroDoTeclado = tecladoOcorrencia.contains(e.target);
        
        if (!dentroDoInput && !dentroDoTeclado) {
            tecladoOcorrencia.classList.add('hidden');
        }
    }
});

/**
 * Digita um n√∫mero ou ponto decimal no campo de quantidade da ocorr√™ncia
 */
function digitarNumeroOcorrencia(digito) {
    const input = document.getElementById('ocorrencia-quantidade');
    const valorAtual = input.value;
    
    // Valida√ß√£o: n√£o permite mais de um ponto decimal
    if (digito === '.' && valorAtual.includes('.')) {
        return;
    }
    
    // Adiciona o d√≠gito
    input.value = valorAtual + digito;
}

/**
 * Remove o √∫ltimo d√≠gito (backspace)
 */
function apagarDigitoOcorrencia() {
    const input = document.getElementById('ocorrencia-quantidade');
    input.value = input.value.slice(0, -1);
}

/**
 * Limpa completamente o campo de quantidade da ocorr√™ncia
 */
function limparQuantidadeOcorrencia() {
    document.getElementById('ocorrencia-quantidade').value = '';
}

/**
 * Fecha o modal de ocorr√™ncia
 */
function fecharModalOcorrencia() {
    modalOcorrencia.classList.add('hidden');
    formOcorrencia.reset();
}

/**
 * Atualiza visibilidade do input de foto conforme online/offline
 */
function atualizarFotoOcorrencia() {
    const inputFoto = document.getElementById('ocorrencia-foto');
    
    if (navigator.onLine) {
        // Online: mostra input, esconde aviso
        inputFoto.style.display = 'block';
        fotoStatusTexto.textContent = '';
    } else {
        // Offline: esconde input, mostra aviso
        inputFoto.style.display = 'none';
        fotoStatusTexto.textContent = 'üìµ Foto indispon√≠vel offline';
        fotoStatusTexto.className = 'text-xs text-gray-400 mt-1';
    }
}

/**
 * Listener para mudan√ßas de conectividade (online/offline)
 */
window.addEventListener('online', atualizarFotoOcorrencia);
window.addEventListener('offline', atualizarFotoOcorrencia);

/**
 * Salva uma ocorr√™ncia (item n√£o cadastrado)
 * Online: envia FormData com foto via /api/registrar_ocorrencia
 * Offline: salva na fila do localStorage sem foto
 */
async function salvarOcorrencia() {
    const nome = document.getElementById('ocorrencia-nome').value.trim();
    const quantidade = parseFloat(document.getElementById('ocorrencia-quantidade').value);
    const unidadeId = parseInt(document.getElementById('ocorrencia-unidade').value);
    const localId = parseInt(document.getElementById('ocorrencia-local-id').value);
    
    // Valida√ß√µes
    if (!nome || !quantidade || !unidadeId) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    if (quantidade <= 0) {
        alert('A quantidade deve ser maior que zero.');
        return;
    }
    
    if (navigator.onLine) {
        // Online: envia com FormData (suporta foto)
        await enviarOcorrenciaOnline(nome, quantidade, unidadeId, localId);
    } else {
        // Offline: salva na fila sem foto
        await salvarOcorrenciaOffline(nome, quantidade, unidadeId, localId);
    }
}

/**
 * Envia ocorr√™ncia online via /api/registrar_ocorrencia
 */
async function enviarOcorrenciaOnline(nome, quantidade, unidadeId, localId) {
    try {
        sincronizandoAtualmente = true;
        atualizarStatusBar();
        
        const formData = new FormData();
        formData.append('nome', nome);
        formData.append('quantidade', quantidade);
        formData.append('unidade_id', unidadeId);
        formData.append('local_id', localId);
        
        // Adiciona foto se fornecida
        const inputFoto = document.getElementById('ocorrencia-foto');
        if (inputFoto.files.length > 0) {
            formData.append('foto', inputFoto.files[0]);
        }
        
        const response = await fetch('/api/registrar_ocorrencia', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok && data.sucesso) {
            fecharModalOcorrencia();
            mostrarToastSucessoLocal();
            tocarBeep();
            
            // Recarrega p√°gina para mostrar a nova ocorr√™ncia (opcional)
            setTimeout(() => window.location.reload(), 1000);
        } else {
            alert(data.error || 'Erro ao registrar ocorr√™ncia.');
        }
    } catch (error) {
        console.error('Erro ao registrar ocorr√™ncia:', error);
        
        // Se falhar, tenta salvar offline
        const quantidade = parseFloat(document.getElementById('ocorrencia-quantidade').value);
        const unidadeId = parseInt(document.getElementById('ocorrencia-unidade').value);
        const localId = parseInt(document.getElementById('ocorrencia-local-id').value);
        const nome = document.getElementById('ocorrencia-nome').value;
        
        await salvarOcorrenciaOffline(nome, quantidade, unidadeId, localId);
    } finally {
        sincronizandoAtualmente = false;
        atualizarStatusBar();
    }
}

/**
 * Salva ocorr√™ncia offline na fila do localStorage
 */
async function salvarOcorrenciaOffline(nome, quantidade, unidadeId, localId) {
    try {
        const ocorrencia = {
            id: Date.now(),
            tipo: 'ocorrencia', // Flag para identificar ocorr√™ncia na sincroniza√ß√£o
            nome,
            quantidade,
            unidade_id: unidadeId,
            local_id: localId,
            timestamp: new Date().toISOString(),
            sincronizado: false
        };
        
        fila.push(ocorrencia);
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(fila));
        
        fecharModalOcorrencia();
        
        // Toast especial para offline
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-yellow-500 text-slate-900 px-4 py-2 rounded-lg font-semibold z-40';
        toast.textContent = 'üìµ Ocorr√™ncia salva (Offline - sem foto)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
        
        tocarBeep();
        atualizarStatusBar();
    } catch (error) {
        console.error('Erro ao salvar ocorr√™ncia offline:', error);
        alert('Erro ao salvar ocorr√™ncia.');
    }
}

/**
 * Listener do formul√°rio de ocorr√™ncia
 */
if (formOcorrencia) {
    formOcorrencia.addEventListener('submit', function(e) {
        e.preventDefault();
        salvarOcorrencia();
    });
}

/**
 * Atualiza sincronizador para lidar com ocorr√™ncias
 */
// Interceptar sincronizarFila para adicionar suporte a ocorr√™ncias
const originalSincronizarFila = window.sincronizarFila;
window.sincronizarFila = async function sincronizarFila() {
    if (fila.length === 0 || !navigator.onLine || sincronizandoAtualmente || servidorInacessivel) {
        atualizarStatusBar();
        return;
    }

    sincronizandoAtualmente = true;
    atualizarStatusBar();

    const primeiroItem = fila[0];

    try {
        let response;
        
        if (primeiroItem.tipo === 'ocorrencia') {
            // √â uma ocorr√™ncia: envia para /api/registrar_ocorrencia
            const formData = new FormData();
            formData.append('nome', primeiroItem.nome);
            formData.append('quantidade', primeiroItem.quantidade);
            formData.append('unidade_id', primeiroItem.unidade_id);
            formData.append('local_id', primeiroItem.local_id);
            
            response = await fetch('/api/registrar_ocorrencia', {
                method: 'POST',
                body: formData
            });
        } else {
            // √â uma contagem normal: mant√©m a l√≥gica original
            response = await fetch(SERVER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    produto_id: primeiroItem.produto_id,
                    local_id: primeiroItem.local_id,
                    quantidade: primeiroItem.quantidade,
                    unidade_id: primeiroItem.unidade_id
                })
            });
        }

        if (response.ok) {
            const data = await response.json();
            if (data.sucesso) {
                // Sucesso: remove da fila
                fila.shift();
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(fila));
                servidorInacessivel = false;
            }
        } else {
            // Erro do servidor: n√£o remove, tenta depois
            throw new Error(`Erro ${response.status}`);
        }
    } catch (error) {
        console.error('Erro ao sincronizar:', error);
        
        // Se √© erro de rede (servidor inacess√≠vel):
        if (error instanceof TypeError || (error.message && error.message.includes('Failed to fetch'))) {
            servidorInacessivel = true;
            // PARA O LOOP de sincroniza√ß√£o para n√£o gastar bateria
            sincronizandoAtualmente = false;
            atualizarStatusBar();
            return;
        }
    }

    sincronizandoAtualmente = false;
    atualizarStatusBar();
};

// ============================================
// CONTROLE DO LOADING OVERLAY
// ============================================
window.addEventListener('load', function() {
    // Esconde o overlay quando a p√°gina terminar de carregar completamente
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
});

window.addEventListener('beforeunload', function() {
    // Mostra o overlay quando a p√°gina est√° sendo recarregada/saindo
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
});
</script>
{% endblock %}

