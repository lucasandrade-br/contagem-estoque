{% extends "base.html" %}

{% block title %}Exportar Lotes{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6 space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <a href="{{ url_for('admin.dashboard') }}" class="text-sm text-blue-400 hover:text-blue-300 inline-flex items-center gap-2">← Voltar ao Dashboard</a>
      <h1 class="text-3xl font-bold text-emerald-400">Exportar Lotes (XLSX)</h1>
      <p class="text-gray-400 text-sm">Selecione os lotes que farão parte do relatório financeiro.</p>
    </div>
    <a href="{{ url_for('admin.lotes_pendentes') }}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm">Ver pendentes</a>
  </div>

  <form method="get" class="bg-slate-800 border border-slate-700 rounded-lg p-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
    <div>
      <label class="block text-sm text-gray-300 font-semibold mb-1">Status</label>
      <select name="status" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg">
        <option value="">Todos</option>
        {% for st in status_opcoes %}
          <option value="{{ st }}" {% if filtros.status == st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm text-gray-300 font-semibold mb-1">Tipo</label>
      <select name="tipo" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg">
        <option value="">Todos</option>
        {% for tp in tipos %}
          <option value="{{ tp }}" {% if filtros.tipo == tp %}selected{% endif %}>{{ tp }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm text-gray-300 font-semibold mb-1">Data inicial</label>
      <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg">
    </div>
    <div>
      <label class="block text-sm text-gray-300 font-semibold mb-1">Data final</label>
      <input type="date" name="data_fim" value="{{ filtros.data_fim }}" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg">
    </div>
    <div class="md:col-span-4 flex gap-3">
      <button type="submit" class="px-4 py-3 bg-amber-600 hover:bg-amber-500 text-white font-semibold rounded-lg">Filtrar</button>
      <a href="{{ url_for('admin.lotes_exportar') }}" class="px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg">Limpar</a>
    </div>
  </form>

  <div class="bg-slate-800 border border-slate-700 rounded-lg">
    {% if lotes %}
    <form method="post">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
        <div class="flex items-center gap-3">
          <input type="checkbox" id="select-all" class="w-5 h-5 bg-slate-700 rounded" aria-label="Selecionar todos">
          <label for="select-all" class="text-gray-200 text-sm">Selecionar todos ({{ lotes|length }})</label>
        </div>
        <button type="submit" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold rounded-lg">Exportar selecionados</button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-900 text-gray-300 uppercase text-xs">
            <tr class="border-b border-slate-700">
              <th class="p-3 text-left"></th>
              <th class="p-3 text-left">Lote</th>
              <th class="p-3 text-left">Tipo</th>
              <th class="p-3 text-left">Motivo</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-left">Criado em</th>
              <th class="p-3 text-left">Fornecedor</th>
              <th class="p-3 text-left">Plano</th>
              <th class="p-3 text-right">Valor (R$)</th>
              <th class="p-3 text-left">Exportado</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-700">
            {% for lote in lotes %}
            <tr class="hover:bg-slate-700/40 transition">
              <td class="p-3">
                <input type="checkbox" name="lote_ids" value="{{ lote.id }}" class="w-5 h-5 align-middle checkbox-row">
              </td>
              <td class="p-3 font-semibold text-gray-100">#{{ lote.id }}</td>
              <td class="p-3 text-gray-200">{{ lote.tipo }}</td>
              <td class="p-3 text-gray-300">{{ lote.motivo }}</td>
              <td class="p-3">
                <span class="px-2 py-1 rounded bg-slate-700 text-gray-200 text-xs font-semibold">{{ lote.status }}</span>
              </td>
              <td class="p-3 text-gray-300">{{ (lote.data_criacao or '')[:16].replace('T',' ') }}</td>
              <td class="p-3 text-gray-200">{{ lote.fornecedor_nome or '-' }}</td>
              <td class="p-3 text-gray-200">{{ lote.plano_descricao or '-' }}</td>
              <td class="p-3 text-right text-emerald-400">{{ '%.2f'|format(lote.valor_total or 0) }}</td>
              <td class="p-3 text-gray-200">{{ 'Sim' if lote.exportado_financeiro else 'Não' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
    {% else %}
    <div class="p-8 text-center text-gray-400">Nenhum lote encontrado para os filtros selecionados.</div>
    {% endif %}
  </div>
</div>

<script>
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.checkbox-row');
  if (selectAll) {
    selectAll.addEventListener('change', () => {
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
    });
  }
</script>
{% endblock %}
