{% extends "base.html" %}

{% block title %}Movimenta√ß√µes de Estoque - Kardex{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">üì¶ Movimenta√ß√µes de Estoque</h1>
                <p class="text-gray-400">Controle de Kardex - Entradas e Sa√≠das</p>
            </div>
            <a href="{{ url_for('admin.dashboard') }}" 
               class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-lg transition">
                ‚Üê Voltar
            </a>
        </div>

        <!-- Estat√≠sticas -->
        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
                <div class="text-emerald-400 text-sm font-semibold mb-1">üìà ENTRADAS</div>
                <div class="text-2xl font-bold text-white">{{ stats.total_entradas|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_entradas|default(0))|round(2) }}</div>
            </div>
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                <div class="text-red-400 text-sm font-semibold mb-1">üìâ SA√çDAS</div>
                <div class="text-2xl font-bold text-white">{{ stats.total_saidas|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_saidas|default(0))|round(2) }}</div>
            </div>
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                <div class="text-blue-400 text-sm font-semibold mb-1">üî¢ IN√çCIO</div>
                <div class="text-2xl font-bold text-white">{{ stats.saldo_inicial|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_saldo_inicial|default(0))|round(2) }}</div>
            </div>
            <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                <div class="text-purple-400 text-sm font-semibold mb-1">üí∞ ATUAL</div>
                <div class="text-2xl font-bold text-white">{{ stats.saldo_atual|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_total_movimentacoes|default(0))|round(2) }}</div>
            </div>
        </div>
        {% endif %}

        <!-- Bot√£o Nova Movimenta√ß√£o -->
        {% if not MODO_LEITURA %}
        <div class="mb-6">
            <button onclick="abrirModalNovaMovimentacao()" 
                    class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold px-6 py-3 rounded-lg transition shadow-lg">
                ‚û• Nova Movimenta√ß√£o
            </button>
        </div>
        {% endif %}

        <!-- Filtros -->
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-white">üîç Filtros</h3>
                {% if filtros.produto_id or filtros.tipo or filtros.motivo or filtros.data_inicio or filtros.data_fim %}
                <span class="bg-amber-500/20 text-amber-400 px-3 py-1 rounded text-xs font-semibold">
                    ‚úì Filtros Ativos
                </span>
                {% endif %}
            </div>
            <form method="GET" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Produto</label>
                    <select name="produto_id" class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Todos</option>
                        {% for p in produtos %}
                        <option value="{{ p.id }}" {% if filtros.produto_id == p.id %}selected{% endif %}>
                            {{ p.nome }}{% if p.id_erp %} ({{ p.id_erp }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Tipo</label>
                    <select name="tipo" class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Todos</option>
                        <option value="ENTRADA" {% if filtros.tipo == 'ENTRADA' %}selected{% endif %}>üìà ENTRADA</option>
                        <option value="SAIDA" {% if filtros.tipo == 'SAIDA' %}selected{% endif %}>üìâ SA√çDA</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Motivo</label>
                    <select name="motivo" class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Todos</option>
                        <option value="COMPRA" {% if filtros.motivo == 'COMPRA' %}selected{% endif %}>COMPRA</option>
                        <option value="VENDA" {% if filtros.motivo == 'VENDA' %}selected{% endif %}>VENDA</option>
                        <option value="QUEBRA" {% if filtros.motivo == 'QUEBRA' %}selected{% endif %}>QUEBRA</option>
                        <option value="VENCIMENTO" {% if filtros.motivo == 'VENCIMENTO' %}selected{% endif %}>VENCIMENTO</option>
                        <option value="AJUSTE_INVENTARIO" {% if filtros.motivo == 'AJUSTE_INVENTARIO' %}selected{% endif %}>AJUSTE INVENTARIO</option>
                        <option value="DEVOLUCAO_CLIENTE" {% if filtros.motivo == 'DEVOLUCAO_CLIENTE' %}selected{% endif %}>DEVOLU√á√ÉO CLIENTE</option>
                        <option value="TRANSFERENCIA_ENTRADA" {% if filtros.motivo == 'TRANSFERENCIA_ENTRADA' %}selected{% endif %}>TRANSFER√äNCIA ENTRADA</option>
                        <option value="TRANSFERENCIA_SAIDA" {% if filtros.motivo == 'TRANSFERENCIA_SAIDA' %}selected{% endif %}>TRANSFER√äNCIA SA√çDA</option>
                        <option value="PRODUCAO" {% if filtros.motivo == 'PRODUCAO' %}selected{% endif %}>PRODU√á√ÉO</option>
                        <option value="CONSUMO" {% if filtros.motivo == 'CONSUMO' %}selected{% endif %}>CONSUMO</option>
                        <option value="AMOSTRA" {% if filtros.motivo == 'AMOSTRA' %}selected{% endif %}>AMOSTRA</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Data In√≠cio</label>
                    <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}"
                           class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Data Fim</label>
                    <input type="date" name="data_fim" value="{{ filtros.data_fim }}"
                           class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                </div>

                <div class="md:col-span-5 flex gap-2">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded transition">
                        üîç Filtrar
                    </button>
                    <a href="{{ url_for('admin.movimentacoes') }}" 
                       class="bg-slate-600 hover:bg-slate-500 text-white px-6 py-2 rounded transition">
                        üîÑ Limpar
                    </a>
                </div>
            </form>
        </div>

        <!-- Tabela de Movimenta√ß√µes -->
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-700/50">
                        <tr class="text-left text-gray-300 font-semibold">
                            <th class="p-3">Data/Hora</th>
                            <th class="p-3">Tipo</th>
                            <th class="p-3">Produto</th>
                            <th class="p-3">Motivo</th>
                            <th class="p-3 text-right">Quantidade</th>
                            <th class="p-3 text-right">Pre√ßo Unit.</th>
                            <th class="p-3 text-right">Valor Total</th>
                            <th class="p-3">Origem</th>
                            <th class="p-3">Usu√°rio</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-300">
                        {% if movimentacoes %}
                            {% for mov in movimentacoes %}
                            <tr class="border-t border-slate-700 hover:bg-slate-700/30">
                                <td class="p-3">{{ mov.data_movimento[:19].replace('T', ' ') }}</td>
                                <td class="p-3">
                                    {% if mov.tipo == 'ENTRADA' %}
                                    <span class="bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded text-xs font-semibold">
                                        üìà ENTRADA
                                    </span>
                                    {% else %}
                                    <span class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs font-semibold">
                                        üìâ SA√çDA
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="p-3">
                                    <a href="{{ url_for('admin.produto_kardex', produto_id=mov.produto_id) }}"
                                       class="text-blue-400 hover:text-blue-300 font-semibold">
                                        {{ mov.produto_nome }}
                                    </a>
                                    {% if mov.id_erp %}
                                    <div class="text-xs text-gray-500">ID: {{ mov.id_erp }}</div>
                                    {% endif %}
                                </td>
                                <td class="p-3">
                                    <span class="bg-slate-600/50 px-2 py-1 rounded text-xs">
                                        {{ mov.motivo }}
                                    </span>
                                </td>
                                <td class="p-3 text-right font-mono">
                                    {% if mov.fator_conversao_usado and mov.fator_conversao_usado != 1.0 %}
                                        {% if mov.tipo == 'ENTRADA' %}
                                        <span class="text-emerald-400">+{{ mov.quantidade_original|round(2) }} {{ mov.unidade_movimentacao }}</span>
                                        <div class="text-xs text-gray-500">({{ mov.quantidade|round(2) }} {{ mov.unidade_padrao }})</div>
                                        {% else %}
                                        <span class="text-red-400">-{{ mov.quantidade_original|round(2) }} {{ mov.unidade_movimentacao }}</span>
                                        <div class="text-xs text-gray-500">({{ mov.quantidade|round(2) }} {{ mov.unidade_padrao }})</div>
                                        {% endif %}
                                    {% else %}
                                        {% if mov.tipo == 'ENTRADA' %}
                                        <span class="text-emerald-400">+{{ mov.quantidade|round(2) }}</span>
                                        {% else %}
                                        <span class="text-red-400">-{{ mov.quantidade|round(2) }}</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="p-3 text-right font-mono text-sm text-gray-300">
                                    R$ {{ mov.preco_custo_unitario|default(0)|round(2) }}
                                </td>
                                <td class="p-3 text-right font-mono font-bold {% if mov.tipo == 'ENTRADA' %}text-emerald-400{% else %}text-red-400{% endif %}">
                                    R$ {{ mov.valor_total|default(0)|round(2) }}
                                </td>
                                <td class="p-3 text-xs text-gray-400">
                                    {{ mov.origem or '-' }}
                                </td>
                                <td class="p-3">{{ mov.usuario_nome or 'Sistema' }}</td>
                                
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="p-8 text-center text-gray-400">
                                Nenhuma movimenta√ß√£o encontrada.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagina√ß√£o -->
        {% if total_paginas > 1 %}
        <div class="flex justify-center gap-2 mt-6">
            {% if pagina_atual > 1 %}
            <a href="{{ url_for('admin.movimentacoes', page=pagina_atual-1, produto_id=filtros.produto_id, tipo=filtros.tipo, motivo=filtros.motivo, data_inicio=filtros.data_inicio, data_fim=filtros.data_fim) }}"
               class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded transition">
                ‚Üê Anterior
            </a>
            {% endif %}
            
            <span class="bg-slate-800 text-white px-4 py-2 rounded border border-slate-600">
                P√°gina {{ pagina_atual }} de {{ total_paginas }}
            </span>
            
            {% if pagina_atual < total_paginas %}
            <a href="{{ url_for('admin.movimentacoes', page=pagina_atual+1, produto_id=filtros.produto_id, tipo=filtros.tipo, motivo=filtros.motivo, data_inicio=filtros.data_inicio, data_fim=filtros.data_fim) }}"
               class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded transition">
                Pr√≥xima ‚Üí
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Nova Movimenta√ß√£o -->
<div id="modalNovaMovimentacao" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 overflow-y-auto p-4">
    <div class="bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-2xl w-full my-auto max-h-[95vh] overflow-y-auto">
        <h2 class="text-2xl font-bold text-white mb-4">‚ûï Nova Movimenta√ß√£o</h2>
        
        <form method="POST" action="{{ url_for('admin.nova_movimentacao') }}" class="space-y-4" id="formMovimentacao">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Produto *</label>
                    <div class="relative">
                        <input type="text" 
                               id="inputBuscaProduto" 
                               placeholder="Digite o nome, c√≥digo de barras ou ID ERP..."
                               autocomplete="off"
                               class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <button type="button" 
                                id="btn-limpar-busca-produto" 
                                onclick="limparBuscaProduto()" 
                                class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white text-xl font-bold w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-600 transition-colors">
                            ‚úï
                        </button>
                        <input type="hidden" name="produto_id" id="hiddenProdutoId" required>
                        
                        <!-- Lista de resultados -->
                        <div id="resultadosBuscaProduto" 
                             class="absolute z-10 w-full mt-1 bg-slate-700 border border-slate-600 rounded-lg max-h-64 overflow-y-auto hidden shadow-lg">
                        </div>
                    </div>
                    <div id="produtoSelecionado" class="hidden mt-2 p-2 bg-slate-800 rounded border border-slate-600">
                        <span class="text-emerald-400 font-semibold" id="nomeProdutoSelecionado"></span>
                        <button type="button" onclick="limparSelecaoProduto()" class="ml-2 text-red-400 hover:text-red-300">‚úï</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Tipo *</label>
                    <select name="tipo" required onchange="atualizarMotivos(this.value)"
                            class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Selecione...</option>
                        <option value="ENTRADA">üìà ENTRADA</option>
                        <option value="SAIDA">üìâ SA√çDA</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Motivo *</label>
                    <select name="motivo" id="selectMotivo" required
                            class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Selecione o tipo primeiro...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Unidade *</label>
                    <select name="unidade_movimentacao" id="selectUnidade" required onchange="atualizarPreviewConversao()"
                            class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Selecione o produto primeiro...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Quantidade *</label>
                    <input type="text" name="quantidade" id="inputQuantidade" required readonly
                           placeholder="Toque para digitar..."
                           class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2 text-center font-bold cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500">
                    
                    <!-- Teclado Num√©rico Customizado (aparece no focus) -->
                    <div id="teclado-movimentacao" class="hidden bg-slate-700/50 rounded-lg p-3 mt-3">
                        <div class="grid grid-cols-3 gap-2">
                            <!-- Linha 1: 7, 8, 9 -->
                            <button type="button" onclick="digitarNumeroMovimentacao('7')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">7</button>
                            <button type="button" onclick="digitarNumeroMovimentacao('8')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">8</button>
                            <button type="button" onclick="digitarNumeroMovimentacao('9')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">9</button>
                            
                            <!-- Linha 2: 4, 5, 6 -->
                            <button type="button" onclick="digitarNumeroMovimentacao('4')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">4</button>
                            <button type="button" onclick="digitarNumeroMovimentacao('5')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">5</button>
                            <button type="button" onclick="digitarNumeroMovimentacao('6')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">6</button>
                            
                            <!-- Linha 3: 1, 2, 3 -->
                            <button type="button" onclick="digitarNumeroMovimentacao('1')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">1</button>
                            <button type="button" onclick="digitarNumeroMovimentacao('2')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">2</button>
                            <button type="button" onclick="digitarNumeroMovimentacao('3')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">3</button>
                            
                            <!-- Linha 4: ., 0, ‚Üê -->
                            <button type="button" onclick="digitarNumeroMovimentacao('.')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">.</button>
                            <button type="button" onclick="digitarNumeroMovimentacao('0')" class="bg-slate-600 hover:bg-slate-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-slate-400">0</button>
                            <button type="button" onclick="apagarDigitoMovimentacao()" class="bg-red-600 hover:bg-red-500 text-white text-2xl font-bold py-4 rounded-lg transition-colors active:bg-red-400">‚Üê</button>
                        </div>
                        
                        <!-- Bot√µes Limpar e Confirmar (2 colunas) -->
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button type="button" onclick="limparQuantidadeMovimentacao()" class="bg-orange-600 hover:bg-orange-500 text-white text-lg font-bold py-3 rounded-lg transition-colors active:bg-orange-400">
                                üóëÔ∏è LIMPAR
                            </button>
                            <button type="button" onclick="confirmarQuantidadeMovimentacao()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-lg font-bold py-3 rounded-lg transition-colors active:bg-emerald-400">
                                ‚úì CONFIRMAR
                            </button>
                        </div>
                    </div>
                </div>

                
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-300 mb-2">Preview Convers√£o</label>
                <div id="previewConversao" class="w-full bg-slate-900/50 border border-slate-600 rounded px-3 py-2 text-amber-400 font-bold text-center">
                    -
                </div>
                <input type="hidden" name="fator_conversao" id="hiddenFator" value="1.0">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-300 mb-2">Origem</label>
                <input type="text" name="origem" maxlength="200"
                       class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2"
                       placeholder="Ex: Nota Fiscal 12345, Pedido #789, etc.">
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-300 mb-2">Observa√ß√£o</label>
                <textarea name="observacao" rows="3" maxlength="500"
                          class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2"
                          placeholder="Informa√ß√µes adicionais..."></textarea>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit" 
                        class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-lg transition">
                    ‚úÖ Registrar Movimenta√ß√£o
                </button>
                <button type="button" onclick="fecharModalNovaMovimentacao()"
                        class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-lg transition">
                    ‚ùå Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const motivosPorTipo = {
    'ENTRADA': ['COMPRA', 'DEVOLUCAO_CLIENTE', 'AJUSTE_INVENTARIO', 'TRANSFERENCIA_ENTRADA', 'PRODUCAO'],
    'SAIDA': ['VENDA', 'QUEBRA', 'VENCIMENTO', 'AJUSTE_INVENTARIO', 'TRANSFERENCIA_SAIDA', 'CONSUMO', 'AMOSTRA']
};

// Lista de produtos para busca
const todosProdutos = {{ produtos | tojson }};

let unidadesProdutoCache = {};
let unidadePadrao = '';
let produtoSelecionadoId = null;

// Elementos DOM
const inputBuscaProduto = document.getElementById('inputBuscaProduto');
const resultadosBuscaProduto = document.getElementById('resultadosBuscaProduto');
const hiddenProdutoId = document.getElementById('hiddenProdutoId');
const produtoSelecionadoDiv = document.getElementById('produtoSelecionado');
const nomeProdutoSelecionado = document.getElementById('nomeProdutoSelecionado');

// ============================================
// BUSCA DE PRODUTOS
// ============================================

inputBuscaProduto.addEventListener('input', function() {
    const termo = this.value.toLowerCase().trim();
    
    // Mostra/oculta bot√£o de limpar baseado no conte√∫do E se est√° focado
    atualizarVisibilidadeBotaoLimpar();
    
    if (termo.length === 0) {
        resultadosBuscaProduto.classList.add('hidden');
        return;
    }
    
    const resultados = todosProdutos.filter(produto => {
        const nome = produto.nome.toLowerCase();
        const gtin = String(produto.gtin || '').toLowerCase();
        const erp = String(produto.id_erp || '').toLowerCase();
        
        return nome.includes(termo) || gtin.includes(termo) || erp.includes(termo);
    });
    
    if (resultados.length === 0) {
        resultadosBuscaProduto.innerHTML = '<div class="p-4 text-gray-400 text-center">Nenhum produto encontrado</div>';
        resultadosBuscaProduto.classList.remove('hidden');
        return;
    }
    
    resultadosBuscaProduto.innerHTML = resultados.map(produto => {
        let subtitulo = '';
        if (produto.id_erp) subtitulo += `ID: ${produto.id_erp}`;
        if (produto.gtin) subtitulo += (subtitulo ? ' | ' : '') + `GTIN: ${produto.gtin}`;
        
        return `
            <button type="button" 
                    onclick="selecionarProduto(${produto.id}, '${produto.nome.replace(/'/g, "\\'")}', '${produto.id_erp || ''}', '${produto.gtin || ''}')" 
                    class="w-full text-left p-3 hover:bg-slate-600 transition-colors border-b border-slate-600 last:border-0">
                <div class="font-semibold text-white">${produto.nome}</div>
                ${subtitulo ? `<div class="text-xs text-gray-400 mt-1">${subtitulo}</div>` : ''}
            </button>
        `;
    }).join('');
    
    resultadosBuscaProduto.classList.remove('hidden');
});

// Mostrar bot√£o X ao focar no campo (se tiver conte√∫do)
inputBuscaProduto.addEventListener('focus', function() {
    atualizarVisibilidadeBotaoLimpar();
});

// Esconder bot√£o X ao perder foco (com delay para permitir clique no bot√£o)
inputBuscaProduto.addEventListener('blur', function() {
    setTimeout(() => {
        document.getElementById('btn-limpar-busca-produto').classList.add('hidden');
    }, 150);
});

/**
 * Atualiza visibilidade do bot√£o de limpar baseado no conte√∫do e foco
 */
function atualizarVisibilidadeBotaoLimpar() {
    const btnLimpar = document.getElementById('btn-limpar-busca-produto');
    const estaFocado = document.activeElement === inputBuscaProduto;
    
    if (inputBuscaProduto.value.length > 0 && estaFocado) {
        btnLimpar.classList.remove('hidden');
    } else {
        btnLimpar.classList.add('hidden');
    }
}

// Fechar busca ao clicar fora
document.addEventListener('click', function(e) {
    if (!inputBuscaProduto.contains(e.target) && !resultadosBuscaProduto.contains(e.target)) {
        resultadosBuscaProduto.classList.add('hidden');
    }
});

function selecionarProduto(id, nome, idErp, gtin) {
    produtoSelecionadoId = id;
    hiddenProdutoId.value = id;
    
    // Mostrar produto selecionado
    let textoCompleto = nome;
    if (idErp) textoCompleto += ` (ID: ${idErp})`;
    if (gtin) textoCompleto += ` [GTIN: ${gtin}]`;
    
    nomeProdutoSelecionado.textContent = textoCompleto;
    produtoSelecionadoDiv.classList.remove('hidden');
    
    // Limpar e esconder busca
    inputBuscaProduto.value = '';
    inputBuscaProduto.classList.add('hidden');
    resultadosBuscaProduto.classList.add('hidden');
    
    // Carregar unidades do produto
    carregarUnidadesProduto(id);
}

function limparSelecaoProduto() {
    produtoSelecionadoId = null;
    hiddenProdutoId.value = '';
    produtoSelecionadoDiv.classList.add('hidden');
    inputBuscaProduto.classList.remove('hidden');
    inputBuscaProduto.value = '';
    inputBuscaProduto.focus();
    
    // Limpar unidades
    const selectUnidade = document.getElementById('selectUnidade');
    selectUnidade.innerHTML = '<option value="">Selecione o produto primeiro...</option>';
    document.getElementById('previewConversao').textContent = '-';
}

/**
 * Limpa o campo de busca de produto e retorna o foco para ele
 */
function limparBuscaProduto() {
    inputBuscaProduto.value = '';
    inputBuscaProduto.focus();
    resultadosBuscaProduto.classList.add('hidden');
    document.getElementById('btn-limpar-busca-produto').classList.add('hidden');
}

// ============================================
// MOTIVOS POR TIPO
// ============================================

function atualizarMotivos(tipo) {
    const select = document.getElementById('selectMotivo');
    select.innerHTML = '<option value="">Selecione...</option>';
    
    if (tipo && motivosPorTipo[tipo]) {
        motivosPorTipo[tipo].forEach(motivo => {
            const option = document.createElement('option');
            option.value = motivo;
            option.textContent = motivo.replace(/_/g, ' ');
            select.appendChild(option);
        });
    }
}

// ============================================
// UNIDADES E CONVERS√ÉO
// ============================================

async function carregarUnidadesProduto(produtoId) {
    const selectUnidade = document.getElementById('selectUnidade');
    selectUnidade.innerHTML = '<option value="">Carregando...</option>';
    
    if (!produtoId) {
        selectUnidade.innerHTML = '<option value="">Selecione o produto primeiro...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/produto/${produtoId}/unidades`);
        const data = await response.json();
        
        if (data.error) {
            selectUnidade.innerHTML = '<option value="">Erro ao carregar unidades</option>';
            return;
        }
        
        unidadesProdutoCache[produtoId] = data;
        unidadePadrao = data.unidade_padrao.sigla;
        
        selectUnidade.innerHTML = '';
        
        // Adicionar unidade padr√£o (fator 1.0)
        const optPadrao = document.createElement('option');
        optPadrao.value = data.unidade_padrao.sigla;
        optPadrao.dataset.fator = 1.0;
        optPadrao.textContent = `${data.unidade_padrao.sigla} - ${data.unidade_padrao.nome} (Padr√£o)`;
        selectUnidade.appendChild(optPadrao);
        
        // Adicionar unidades alternativas
        data.unidades_alternativas.forEach(unidade => {
            const option = document.createElement('option');
            option.value = unidade.sigla;
            option.dataset.fator = unidade.fator;
            option.textContent = `${unidade.sigla} - ${unidade.nome} (1 = ${unidade.fator} ${data.unidade_padrao.sigla})`;
            selectUnidade.appendChild(option);
        });
        
        // Selecionar a primeira op√ß√£o por padr√£o
        selectUnidade.selectedIndex = 0;
        atualizarPreviewConversao();
        
    } catch (error) {
        console.error('Erro ao carregar unidades:', error);
        selectUnidade.innerHTML = '<option value="">Erro ao carregar unidades</option>';
    }
}

function atualizarPreviewConversao() {
    const selectUnidade = document.getElementById('selectUnidade');
    const inputQuantidade = document.getElementById('inputQuantidade');
    const previewDiv = document.getElementById('previewConversao');
    const hiddenFator = document.getElementById('hiddenFator');
    
    const selectedOption = selectUnidade.options[selectUnidade.selectedIndex];
    const fator = parseFloat(selectedOption?.dataset.fator || 1.0);
    const quantidade = parseFloat(inputQuantidade.value || 0);
    const unidadeSelecionada = selectUnidade.value;
    
    // Atualizar campo hidden com o fator
    hiddenFator.value = fator;
    
    if (quantidade > 0 && unidadeSelecionada) {
        const quantidadeConvertida = quantidade * fator;
        
        if (fator === 1.0) {
            previewDiv.textContent = `${quantidadeConvertida.toFixed(2)} ${unidadePadrao}`;
        } else {
            previewDiv.textContent = `${quantidade} ${unidadeSelecionada} √ó ${fator} = ${quantidadeConvertida.toFixed(2)} ${unidadePadrao}`;
        }
        previewDiv.classList.remove('text-gray-500');
        previewDiv.classList.add('text-amber-400');
    } else {
        previewDiv.textContent = '-';
        previewDiv.classList.remove('text-amber-400');
        previewDiv.classList.add('text-gray-500');
    }
}

// ============================================
// MODAL
// ============================================

function abrirModalNovaMovimentacao() {
    document.getElementById('modalNovaMovimentacao').classList.remove('hidden');
    document.getElementById('modalNovaMovimentacao').classList.add('flex');
    
    // Resetar formul√°rio
    limparSelecaoProduto();
    document.getElementById('formMovimentacao').reset();
}

function fecharModalNovaMovimentacao() {
    document.getElementById('modalNovaMovimentacao').classList.add('hidden');
    document.getElementById('modalNovaMovimentacao').classList.remove('flex');
}

// Fechar modal ao clicar fora
document.getElementById('modalNovaMovimentacao').addEventListener('click', function(e) {
    if (e.target === this) {
        fecharModalNovaMovimentacao();
    }
});

// Fechar com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fecharModalNovaMovimentacao();
    }
});

// ============================================
// TECLADO NUM√âRICO PERSONALIZADO
// ============================================

const inputQuantidade = document.getElementById('inputQuantidade');
const tecladoMovimentacao = document.getElementById('teclado-movimentacao');

// Mostrar teclado ao focar no campo
inputQuantidade.addEventListener('focus', function() {
    tecladoMovimentacao.classList.remove('hidden');
});

// Esconder teclado ao clicar fora (com delay para permitir cliques nos bot√µes)
inputQuantidade.addEventListener('blur', function(e) {
    // Delay para permitir que o clique no bot√£o seja registrado primeiro
    setTimeout(() => {
        // Verifica se o foco n√£o foi para um bot√£o do teclado
        if (!tecladoMovimentacao.contains(document.activeElement)) {
            tecladoMovimentacao.classList.add('hidden');
        }
    }, 150);
});

// Previne que o blur aconte√ßa ao clicar nos bot√µes do teclado
tecladoMovimentacao.addEventListener('mousedown', function(e) {
    e.preventDefault();
});

/**
 * Digita um n√∫mero ou ponto decimal no campo de quantidade da movimenta√ß√£o
 */
function digitarNumeroMovimentacao(digito) {
    const valorAtual = inputQuantidade.value;
    
    // Valida√ß√£o: n√£o permite mais de um ponto decimal
    if (digito === '.' && valorAtual.includes('.')) {
        return;
    }
    
    // Adiciona o d√≠gito
    inputQuantidade.value = valorAtual + digito;
    
    // Atualiza preview de convers√£o
    atualizarPreviewConversao();
}

/**
 * Remove o √∫ltimo d√≠gito (backspace)
 */
function apagarDigitoMovimentacao() {
    inputQuantidade.value = inputQuantidade.value.slice(0, -1);
    atualizarPreviewConversao();
}

/**
 * Limpa completamente o campo de quantidade da movimenta√ß√£o
 */
function limparQuantidadeMovimentacao() {
    inputQuantidade.value = '';
    atualizarPreviewConversao();
}

/**
 * Confirma a quantidade digitada, oculta o teclado e remove o foco
 */
function confirmarQuantidadeMovimentacao() {
    // Remove foco do campo (isso j√° vai esconder o teclado pelo evento blur)
    inputQuantidade.blur();
    
    // Garante que o teclado seja escondido imediatamente
    tecladoMovimentacao.classList.add('hidden');
}
</script>
{% endblock %}
