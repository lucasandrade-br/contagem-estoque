{% extends "base.html" %}

{% block title %}Movimenta√ß√µes de Estoque - Kardex{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">üì¶ Movimenta√ß√µes de Estoque</h1>
                <p class="text-gray-400">Controle de Kardex - Entradas e Sa√≠das</p>
            </div>
            <a href="{{ url_for('admin.dashboard') }}" 
               class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-lg transition">
                ‚Üê Voltar
            </a>
        </div>

        <!-- Estat√≠sticas -->
        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
                <div class="text-emerald-400 text-sm font-semibold mb-1">üìà ENTRADAS</div>
                <div class="text-2xl font-bold text-white">{{ stats.total_entradas|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_entradas|default(0))|round(2) }}</div>
            </div>
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                <div class="text-red-400 text-sm font-semibold mb-1">üìâ SA√çDAS</div>
                <div class="text-2xl font-bold text-white">{{ stats.total_saidas|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_saidas|default(0))|round(2) }}</div>
            </div>
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                <div class="text-blue-400 text-sm font-semibold mb-1">üî¢ IN√çCIO</div>
                <div class="text-2xl font-bold text-white">{{ stats.saldo_inicial|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_saldo_inicial|default(0))|round(2) }}</div>
            </div>
            <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                <div class="text-purple-400 text-sm font-semibold mb-1">üí∞ ATUAL</div>
                <div class="text-2xl font-bold text-white">{{ stats.saldo_atual|default(0)|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_total_movimentacoes|default(0))|round(2) }}</div>
            </div>
        </div>
        {% endif %}

        <!-- Bot√£o Nova Movimenta√ß√£o (Redireciona para sistema de lotes) -->
        {% if not MODO_LEITURA %}
        <div class="mb-6">
            <a href="{{ url_for('admin.lote_novo') }}" 
               class="inline-block bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold px-6 py-3 rounded-lg transition shadow-lg">
                ‚û• Novo Lote de Movimenta√ß√£o
            </a>
        </div>
        {% endif %}

        <!-- Filtros -->
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-white">üîç Filtros</h3>
                {% if filtros.produto_id or filtros.tipo or filtros.motivo or filtros.data_inicio or filtros.data_fim %}
                <span class="bg-amber-500/20 text-amber-400 px-3 py-1 rounded text-xs font-semibold">
                    ‚úì Filtros Ativos
                </span>
                {% endif %}
            </div>
            <form method="GET" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Produto</label>
                    <select name="produto_id" class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Todos</option>
                        {% for p in produtos %}
                        <option value="{{ p.id }}" {% if filtros.produto_id == p.id %}selected{% endif %}>
                            {{ p.nome }}{% if p.id_erp %} ({{ p.id_erp }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Tipo</label>
                    <select name="tipo" class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Todos</option>
                        <option value="ENTRADA" {% if filtros.tipo == 'ENTRADA' %}selected{% endif %}>üìà ENTRADA</option>
                        <option value="SAIDA" {% if filtros.tipo == 'SAIDA' %}selected{% endif %}>üìâ SA√çDA</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Motivo</label>
                    <select name="motivo" class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                        <option value="">Todos</option>
                        <option value="COMPRA" {% if filtros.motivo == 'COMPRA' %}selected{% endif %}>COMPRA</option>
                        <option value="VENDA" {% if filtros.motivo == 'VENDA' %}selected{% endif %}>VENDA</option>
                        <option value="QUEBRA" {% if filtros.motivo == 'QUEBRA' %}selected{% endif %}>QUEBRA</option>
                        <option value="VENCIMENTO" {% if filtros.motivo == 'VENCIMENTO' %}selected{% endif %}>VENCIMENTO</option>
                        <option value="AJUSTE_INVENTARIO" {% if filtros.motivo == 'AJUSTE_INVENTARIO' %}selected{% endif %}>AJUSTE INVENTARIO</option>
                        <option value="DEVOLUCAO_CLIENTE" {% if filtros.motivo == 'DEVOLUCAO_CLIENTE' %}selected{% endif %}>DEVOLU√á√ÉO CLIENTE</option>
                        <option value="TRANSFERENCIA_ENTRADA" {% if filtros.motivo == 'TRANSFERENCIA_ENTRADA' %}selected{% endif %}>TRANSFER√äNCIA ENTRADA</option>
                        <option value="TRANSFERENCIA_SAIDA" {% if filtros.motivo == 'TRANSFERENCIA_SAIDA' %}selected{% endif %}>TRANSFER√äNCIA SA√çDA</option>
                        <option value="PRODUCAO" {% if filtros.motivo == 'PRODUCAO' %}selected{% endif %}>PRODU√á√ÉO</option>
                        <option value="CONSUMO" {% if filtros.motivo == 'CONSUMO' %}selected{% endif %}>CONSUMO</option>
                        <option value="AMOSTRA" {% if filtros.motivo == 'AMOSTRA' %}selected{% endif %}>AMOSTRA</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Data In√≠cio</label>
                    <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}"
                           class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Data Fim</label>
                    <input type="date" name="data_fim" value="{{ filtros.data_fim }}"
                           class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                </div>

                <div class="md:col-span-5 flex gap-2">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded transition">
                        üîç Filtrar
                    </button>
                    <a href="{{ url_for('admin.movimentacoes') }}" 
                       class="bg-slate-600 hover:bg-slate-500 text-white px-6 py-2 rounded transition">
                        üîÑ Limpar
                    </a>
                </div>
            </form>
        </div>

        <!-- Tabela de Movimenta√ß√µes -->
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-700/50">
                        <tr class="text-left text-gray-300 font-semibold">
                            <th class="p-3">Data/Hora</th>
                            <th class="p-3">Tipo</th>
                            <th class="p-3">Produto</th>
                            <th class="p-3">Motivo</th>
                            <th class="p-3 text-right">Quantidade</th>
                            <th class="p-3 text-right">Pre√ßo Unit.</th>
                            <th class="p-3 text-right">Valor Total</th>
                            <th class="p-3">Origem</th>
                            <th class="p-3">Usu√°rio</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-300">
                        {% if movimentacoes %}
                            {% for mov in movimentacoes %}
                            <tr class="border-t border-slate-700 hover:bg-slate-700/30">
                                <td class="p-3">{{ mov.data_movimento[:19].replace('T', ' ') }}</td>
                                <td class="p-3">
                                    {% if mov.tipo == 'ENTRADA' %}
                                    <span class="bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded text-xs font-semibold">
                                        üìà ENTRADA
                                    </span>
                                    {% else %}
                                    <span class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs font-semibold">
                                        üìâ SA√çDA
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="p-3">
                                    <a href="{{ url_for('admin.produto_kardex', produto_id=mov.produto_id) }}"
                                       class="text-blue-400 hover:text-blue-300 font-semibold">
                                        {{ mov.produto_nome }}
                                    </a>
                                    {% if mov.id_erp %}
                                    <div class="text-xs text-gray-500">ID: {{ mov.id_erp }}</div>
                                    {% endif %}
                                </td>
                                <td class="p-3">
                                    <span class="bg-slate-600/50 px-2 py-1 rounded text-xs">
                                        {{ mov.motivo }}
                                    </span>
                                </td>
                                <td class="p-3 text-right font-mono">
                                    {% if mov.fator_conversao_usado and mov.fator_conversao_usado != 1.0 %}
                                        {% if mov.tipo == 'ENTRADA' %}
                                        <span class="text-emerald-400">+{{ mov.quantidade_original|round(2) }} {{ mov.unidade_movimentacao }}</span>
                                        <div class="text-xs text-gray-500">({{ mov.quantidade|round(2) }} {{ mov.unidade_padrao }})</div>
                                        {% else %}
                                        <span class="text-red-400">-{{ mov.quantidade_original|round(2) }} {{ mov.unidade_movimentacao }}</span>
                                        <div class="text-xs text-gray-500">({{ mov.quantidade|round(2) }} {{ mov.unidade_padrao }})</div>
                                        {% endif %}
                                    {% else %}
                                        {% if mov.tipo == 'ENTRADA' %}
                                        <span class="text-emerald-400">+{{ mov.quantidade|round(2) }}</span>
                                        {% else %}
                                        <span class="text-red-400">-{{ mov.quantidade|round(2) }}</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="p-3 text-right font-mono text-sm text-gray-300">
                                    R$ {{ mov.preco_custo_unitario|default(0)|round(2) }}
                                </td>
                                <td class="p-3 text-right font-mono font-bold {% if mov.tipo == 'ENTRADA' %}text-emerald-400{% else %}text-red-400{% endif %}">
                                    R$ {{ mov.valor_total|default(0)|round(2) }}
                                </td>
                                <td class="p-3 text-xs text-gray-400">
                                    {{ mov.origem or '-' }}
                                </td>
                                <td class="p-3">{{ mov.usuario_nome or 'Sistema' }}</td>
                                
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="p-8 text-center text-gray-400">
                                Nenhuma movimenta√ß√£o encontrada.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagina√ß√£o -->
        {% if total_paginas > 1 %}
        <div class="flex justify-center gap-2 mt-6">
            {% if pagina_atual > 1 %}
            <a href="{{ url_for('admin.movimentacoes', page=pagina_atual-1, produto_id=filtros.produto_id, tipo=filtros.tipo, motivo=filtros.motivo, data_inicio=filtros.data_inicio, data_fim=filtros.data_fim) }}"
               class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded transition">
                ‚Üê Anterior
            </a>
            {% endif %}
            
            <span class="bg-slate-800 text-white px-4 py-2 rounded border border-slate-600">
                P√°gina {{ pagina_atual }} de {{ total_paginas }}
            </span>
            
            {% if pagina_atual < total_paginas %}
            <a href="{{ url_for('admin.movimentacoes', page=pagina_atual+1, produto_id=filtros.produto_id, tipo=filtros.tipo, motivo=filtros.motivo, data_inicio=filtros.data_inicio, data_fim=filtros.data_fim) }}"
               class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded transition">
                Pr√≥xima ‚Üí
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}
