{% extends "base.html" %}

{% block title %}Lote #{{ lote.id }} - Detalhe{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-amber-500">Movimenta√ß√£o #{{ lote.id }}</h1>
        <a href="{{ url_for('admin.lotes_pendentes') }}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
            ‚Üê Voltar
        </a>
    </div>
    
    <!-- Aviso -->
    {% if lotes_anteriores_pendentes > 0 %}
    <div class="bg-amber-900/30 border border-amber-500 rounded-lg p-4 mb-4 flex items-center gap-3">
        <svg class="w-6 h-6 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <div>
            <p class="text-amber-300 font-semibold">Aten√ß√£o: Aprova√ß√£o fora de ordem</p>
            <p class="text-amber-200 text-sm">Existem {{ lotes_anteriores_pendentes }} lote(s) anterior(es) ainda pendente(s). Voc√™ pode aprovar este mesmo assim, mas certifique-se de que n√£o h√° depend√™ncia.</p>
        </div>
    </div>
    {% endif %}
    
    <!-- Informa√ß√µes do Lote -->
    <div class="bg-slate-800 rounded-lg p-6 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <span class="text-gray-400 text-sm">Status</span>
                <p class="text-yellow-400 font-bold">{{ lote.status }}</p>
            </div>
            <div>
                <span class="text-gray-400 text-sm">Tipo / Motivo</span>
                <p class="text-white font-semibold">{{ lote.tipo }}</p>
                <p class="text-gray-300 text-sm">{{ lote.motivo }}</p>
            </div>
            <div>
                <span class="text-gray-400 text-sm">Criado por</span>
                <p class="text-white font-semibold">{{ lote.usuario_criador_nome }}</p>
                <p class="text-gray-300 text-sm">{{ lote.data_criacao[:16].replace('T', ' ') }}</p>
            </div>
            <div>
                <span class="text-gray-400 text-sm">Total de Itens</span>
                <p class="text-white font-bold text-xl">{{ itens|length }}</p>
            </div>
        </div>
    </div>
    
    <!-- Tabela de Itens -->
    <div class="bg-slate-800 rounded-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-100">Itens do Lote</h2>
            {% if lote.status == 'PENDENTE_APROVACAO' %}
            <button onclick="abrirModalAdicionar()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg transition text-sm">
                ‚ûï Adicionar Item
            </button>
            {% endif %}
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-slate-700">
                        <th class="text-left text-gray-400 py-2">Produto</th>
                        <th class="text-right text-gray-400 py-2">Quantidade</th>
                        <th class="text-right text-gray-400 py-2">Pre√ßo</th>
                        <th class="text-right text-gray-400 py-2">Subtotal</th>
                        {% if lote.status == 'PENDENTE_APROVACAO' %}
                        <th class="text-center text-gray-400 py-2">A√ß√µes</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody class="text-gray-300" id="tbody-itens">
                    {% for item in itens %}
                    <tr class="border-b border-slate-700" data-item-id="{{ item.id }}">
                        <td class="py-2">{{ item.produto_nome }}</td>
                        <td class="text-right">
                            <span class="qtd-display">{{ item.quantidade_original }}</span> {{ item.unidade_movimentacao }}
                            {% if item.fator_conversao != 1.0 %}
                            <br><span class="text-xs text-amber-400">({{ (item.quantidade_original * item.fator_conversao)|round(2) }} {{ item.unidade_padrao_sigla }})</span>
                            {% endif %}
                        </td>
                        <td class="text-right preco-display">R$ {{ "%.2f"|format(item.preco_custo_unitario or 0) }}</td>
                        <td class="text-right subtotal-display">R$ {{ "%.2f"|format((item.quantidade_original * item.fator_conversao) * (item.preco_custo_unitario or 0)) }}</td>
                        {% if lote.status == 'PENDENTE_APROVACAO' %}
                        <td class="text-center">
                            <button onclick="abrirModalEditar({{ item.id }}, '{{ item.produto_nome }}', {{ item.quantidade_original }}, {{ item.preco_custo_unitario or 0 }}, '{{ item.observacao or '' }}')" 
                                    class="px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs mr-1">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="removerItem({{ item.id }})" 
                                    class="px-2 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-xs">
                                üóëÔ∏è
                            </button>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    {% if lote.tipo == 'ENTRADA' %}
    <!-- Dados Financeiros -->
    <div id="secao-financeiro" class="bg-slate-800 rounded-lg p-6 mb-6 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <h2 class="text-xl font-bold text-gray-100">Dados financeiros</h2>
                <span class="text-xs text-amber-400">Apenas ENTRADA</span>
                {% if lote.exportado_financeiro %}
                <span class="px-2 py-1 text-xs rounded bg-emerald-900 text-emerald-300 border border-emerald-500">Exportado</span>
                {% endif %}
            </div>
            
        </div>

        <form id="form-financeiro" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">Fornecedor <span class="text-red-500">*</span></label>
                    <input id="financeiro-fornecedor-busca" type="text" placeholder="Digite para filtrar" class="w-full p-2 mb-2 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm">
                    <select id="financeiro-fornecedor" required class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">Plano de contas <span class="text-red-500">*</span></label>
                    <input id="financeiro-plano-busca" type="text" placeholder="Digite para filtrar" class="w-full p-2 mb-2 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm">
                    <select id="financeiro-plano" required class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">N¬∫ documento</label>
                    <input id="financeiro-num-doc" type="text" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="NF, pedido...">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">Valor total</label>
                    <input id="financeiro-valor-total" type="number" step="0.01" min="0" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <p class="text-xs text-gray-400 mt-1">Soma dos itens, edit√°vel.</p>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2 font-semibold">Data emiss√£o</label>
                    <input id="financeiro-emissao" type="date" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="flex items-end gap-2">
                    <div class="flex items-center gap-2">
                        <input id="financeiro-pago" type="checkbox" class="w-4 h-4 text-emerald-500">
                        <label for="financeiro-pago" class="text-gray-200 font-semibold">Pagamento efetuado?</label>
                    </div>
                </div>
                <div class="pagamento-field hidden">
                    <label class="block text-gray-300 mb-2 font-semibold">Valor pago</label>
                    <input id="financeiro-valor-pago" type="number" step="0.01" min="0" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" disabled>
                </div>
                <div class="pagamento-field hidden">
                    <label class="block text-gray-300 mb-2 font-semibold">Data pagamento</label>
                    <input id="financeiro-data-pago" type="date" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" disabled>
                </div>
            </div>

            <div class="flex flex-col md:flex-row md:items-end gap-3">
                <div class="md:w-40">
                    <label class="block text-gray-300 mb-2 font-semibold">N¬∫ parcelas</label>
                    <input id="financeiro-qtd-parcelas" type="number" min="1" value="1" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="flex-1">
                    <label class="block text-gray-300 mb-2 font-semibold">Vencimento base</label>
                    <input id="financeiro-venc-base" type="date" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="md:w-48">
                    <button type="button" id="btn-gerar-parcelas" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 rounded-lg transition">
                        Gerar parcelas
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto border border-slate-700 rounded-lg">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-slate-700 text-gray-400">
                            <th class="text-left py-2 px-3">Parcela</th>
                            <th class="text-left py-2 px-3">Vencimento</th>
                            <th class="text-left py-2 px-3">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="parcelas-body" class="text-gray-200"></tbody>
                    <tfoot>
                        <tr class="border-t border-slate-700 font-bold text-amber-400">
                            <td colspan="2" class="py-2 px-3 text-right">Soma das parcelas:</td>
                            <td class="py-2 px-3" id="parcelas-soma">R$ 0,00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div>
                <label class="block text-gray-300 mb-2 font-semibold">Observa√ß√£o</label>
                <textarea id="financeiro-observacao" rows="3" class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Anota√ß√µes internas"></textarea>
            </div>

            <div class="flex flex-col md:flex-row gap-3">
                <button type="submit" id="btn-salvar-financeiro" class="w-full md:w-56 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition">
                    Salvar dados financeiros
                </button>
                <p id="financeiro-aviso-leitura" class="text-sm text-gray-300 md:flex-1 md:self-center hidden"></p>
            </div>
            <p id="financeiro-status" class="text-sm text-gray-300"></p>
        </form>
    </div>
    {% endif %}

    <!-- A√ß√µes -->
    {% if lote.status == 'PENDENTE_APROVACAO' %}
    <div class="flex gap-4">
        <button onclick="aprovarLote()" 
                class="flex-1 px-6 py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg transition text-lg">
            ‚úÖ APROVAR MOVIMENTA√á√ÉO
        </button>
        <button onclick="abrirModalRejeitar()" 
                class="flex-1 px-6 py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition text-lg">
            ‚ùå REJEITAR MOVIMENTA√á√ÉO
        </button>
    </div>
    {% endif %}
</div>

<!-- Modal Rejei√ß√£o -->
<div id="modal-rejeitar" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full">
        <h3 class="text-xl font-bold text-red-500 mb-4">Rejeitar Lote #{{ lote.id }}</h3>
        <p class="text-gray-300 mb-4">Informe o motivo da rejei√ß√£o:</p>
        <textarea id="motivo-rejeicao" rows="4" 
                  class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-red-500 focus:outline-none mb-4" 
                  placeholder="Ex: Pre√ßos incorretos, produto errado, etc."></textarea>
        <div class="flex gap-3">
            <button onclick="fecharModalRejeitar()" 
                    class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                Cancelar
            </button>
            <button onclick="rejeitarLote()" 
                    class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">
                Confirmar Rejei√ß√£o
            </button>
        </div>
    </div>
</div>

<!-- Modal Editar Item -->
<div id="modal-editar" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full">
        <h3 class="text-xl font-bold text-blue-400 mb-4">Editar Item</h3>
        <input type="hidden" id="edit-item-id">
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Produto</label>
            <input type="text" id="edit-produto-nome" readonly 
                   class="w-full p-3 bg-slate-700 text-gray-400 rounded-lg border border-slate-600">
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Quantidade</label>
            <input type="number" id="edit-quantidade" step="0.01" min="0.01" 
                   class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Pre√ßo Unit√°rio (R$)</label>
            <input type="number" id="edit-preco" step="0.01" min="0" 
                   class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Observa√ß√£o</label>
            <textarea id="edit-observacao" rows="2" 
                      class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
        </div>
        
        <div class="flex gap-3">
            <button onclick="fecharModalEditar()" 
                    class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                Cancelar
            </button>
            <button onclick="salvarEdicao()" 
                    class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">
                üíæ Salvar
            </button>
        </div>
    </div>
</div>

<!-- Modal Adicionar Item -->
<div id="modal-adicionar" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="bg-slate-800 rounded-xl p-6 max-w-lg w-full">
        <h3 class="text-xl font-bold text-emerald-400 mb-4">Adicionar Item ao Lote</h3>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Produto</label>
            <input type="text" id="add-produto-search" placeholder="Digite para buscar..." 
                   class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none">
            <div id="add-produto-results" class="mt-2 max-h-48 overflow-y-auto"></div>
            <input type="hidden" id="add-produto-id">
        </div>
        
        <div id="add-unidades-section" class="mb-4 hidden">
            <label class="block text-gray-300 text-sm font-bold mb-2">Unidade de Movimenta√ß√£o</label>
            <select id="add-unidade" class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none">
                <option value="">Selecione...</option>
            </select>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Quantidade</label>
            <input type="number" id="add-quantidade" step="0.01" min="0.01" 
                   class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none">
            <p id="add-conversao-display" class="text-xs text-amber-400 mt-1"></p>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Pre√ßo Unit√°rio (R$)</label>
            <input type="number" id="add-preco" step="0.01" min="0" 
                   class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none">
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-300 text-sm font-bold mb-2">Observa√ß√£o</label>
            <textarea id="add-observacao" rows="2" 
                      class="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-emerald-500 focus:outline-none"></textarea>
        </div>
        
        <div class="flex gap-3">
            <button onclick="fecharModalAdicionar()" 
                    class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                Cancelar
            </button>
            <button onclick="adicionarNovoItem()" 
                    class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg">
                ‚ûï Adicionar
            </button>
        </div>
    </div>
</div>

<script>
const LOTE_ID = {{ lote.id }};
let produtosCache = [];
let unidadesCache = {};
const FINANCE_PREFILL = {{ financeiro|tojson or 'null' }};
const FINANCE_PARCELAS = {{ parcelas_fin|tojson or '[]' }};
const CAN_EDIT_FIN = {{ 'true' if lote.status in ['PENDENTE_APROVACAO','FINALIZADO','RASCUNHO'] else 'false' }};
const VALOR_ITENS_TOTAL = {{ valor_itens_total or 0 }};
let FORNECEDORES_CACHE = [];
let PLANOS_CACHE = [];
let FINANCEIRO_SALVO = Boolean(FINANCE_PREFILL);

function normalize(str) {
    return (str || '').toLowerCase();
}

function aprovarLote() {
    if (!confirm('Aprovar este lote? As movimenta√ß√µes ser√£o aplicadas ao estoque.')) return;

    if ({{ 'true' if lote.tipo == 'ENTRADA' else 'false' }}) {
        const erros = validarFinanceiroPreAprovacao();
        if (erros.length > 0) {
            alert('Corrija os dados financeiros antes de aprovar:\n- ' + erros.join('\n- '));
            return;
        }
    }
    
    fetch('/lotes/{{ lote.id }}/aprovar', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.sucesso) {
            alert('‚úÖ ' + data.message);
            window.location.href = '{{ url_for("admin.lotes_pendentes") }}';
        } else {
            alert('‚ùå Erro: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(err => {
        alert('‚ùå Erro ao aprovar: ' + err.message);
    });
}

function abrirModalRejeitar() {
    document.getElementById('modal-rejeitar').classList.remove('hidden');
}

function fecharModalRejeitar() {
    document.getElementById('modal-rejeitar').classList.add('hidden');
    document.getElementById('motivo-rejeicao').value = '';
}

function rejeitarLote() {
    const motivo = document.getElementById('motivo-rejeicao').value.trim();
    
    if (!motivo) {
        alert('Informe o motivo da rejei√ß√£o');
        return;
    }
    
    fetch('/lotes/{{ lote.id }}/rejeitar', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({motivo})
    })
    .then(res => res.json())
    .then(data => {
        if (data.sucesso) {
            alert('‚úÖ ' + data.message);
            window.location.href = '{{ url_for("admin.lotes_pendentes") }}';
        } else {
            alert('‚ùå Erro: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(err => {
        alert('‚ùå Erro ao rejeitar: ' + err.message);
    });
}

// EDI√á√ÉO DE ITEM
function abrirModalEditar(itemId, produtoNome, quantidade, preco, observacao) {
    document.getElementById('edit-item-id').value = itemId;
    document.getElementById('edit-produto-nome').value = produtoNome;
    document.getElementById('edit-quantidade').value = quantidade;
    document.getElementById('edit-preco').value = preco;
    document.getElementById('edit-observacao').value = observacao || '';
    document.getElementById('modal-editar').classList.remove('hidden');
}

function fecharModalEditar() {
    document.getElementById('modal-editar').classList.add('hidden');
}

function salvarEdicao() {
    const itemId = document.getElementById('edit-item-id').value;
    const quantidade = parseFloat(document.getElementById('edit-quantidade').value);
    const preco = parseFloat(document.getElementById('edit-preco').value);
    const observacao = document.getElementById('edit-observacao').value.trim();
    
    if (!quantidade || quantidade <= 0) {
        alert('Quantidade inv√°lida');
        return;
    }
    
    fetch(`/lotes/${LOTE_ID}/item/${itemId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            quantidade_original: quantidade,
            preco_custo_unitario: preco,
            observacao: observacao
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.sucesso) {
            alert('‚úÖ Item atualizado!');
            location.reload();
        } else {
            alert('‚ùå Erro: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(err => alert('‚ùå Erro: ' + err.message));
}

function removerItem(itemId) {
    if (!confirm('Remover este item do lote?')) return;
    
    fetch(`/lotes/${LOTE_ID}/item/${itemId}`, {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
        if (data.sucesso) {
            alert('‚úÖ Item removido!');
            location.reload();
        } else {
            alert('‚ùå Erro: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(err => alert('‚ùå Erro: ' + err.message));
}

// ADI√á√ÉO DE NOVO ITEM
function abrirModalAdicionar() {
    document.getElementById('modal-adicionar').classList.remove('hidden');
    limparModalAdicionar();
}

function fecharModalAdicionar() {
    document.getElementById('modal-adicionar').classList.add('hidden');
    limparModalAdicionar();
}

function limparModalAdicionar() {
    document.getElementById('add-produto-search').value = '';
    document.getElementById('add-produto-id').value = '';
    document.getElementById('add-produto-results').innerHTML = '';
    document.getElementById('add-unidades-section').classList.add('hidden');
    document.getElementById('add-quantidade').value = '';
    document.getElementById('add-preco').value = '';
    document.getElementById('add-observacao').value = '';
    document.getElementById('add-conversao-display').textContent = '';
}

// Busca de produtos
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('add-produto-search');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const termo = this.value.trim();
            if (termo.length < 2) {
                document.getElementById('add-produto-results').innerHTML = '';
                return;
            }
            buscarProdutos(termo);
        });
    }
    
    const unidadeSelect = document.getElementById('add-unidade');
    const qtdInput = document.getElementById('add-quantidade');
    if (unidadeSelect && qtdInput) {
        unidadeSelect.addEventListener('change', atualizarConversaoAdicionar);
        qtdInput.addEventListener('input', atualizarConversaoAdicionar);
    }
});

function buscarProdutos(termo) {
    fetch(`/api/produtos/buscar?q=${encodeURIComponent(termo)}`)
        .then(res => res.json())
        .then(produtos => {
            produtosCache = produtos;
            const resultsDiv = document.getElementById('add-produto-results');
            resultsDiv.innerHTML = '';
            
            if (produtos.length === 0) {
                resultsDiv.innerHTML = '<p class="text-gray-400 text-sm">Nenhum produto encontrado</p>';
                return;
            }
            
            produtos.forEach(p => {
                const div = document.createElement('div');
                div.className = 'p-2 bg-slate-700 hover:bg-slate-600 rounded cursor-pointer mb-1';
                div.textContent = `${p.id_erp || p.id} - ${p.nome}`;
                div.onclick = () => selecionarProdutoAdicionar(p);
                resultsDiv.appendChild(div);
            });
        })
        .catch(err => console.error('Erro ao buscar produtos:', err));
}

function selecionarProdutoAdicionar(produto) {
    document.getElementById('add-produto-search').value = `${produto.id_erp || produto.id} - ${produto.nome}`;
    document.getElementById('add-produto-id').value = produto.id;
    document.getElementById('add-produto-results').innerHTML = '';
    document.getElementById('add-preco').value = produto.preco_custo || 0;
    
    // Carregar unidades do produto
    fetch(`/api/produto/${produto.id}/unidades`)
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('add-unidade');
            select.innerHTML = '<option value="">Selecione...</option>';
            
            // Adicionar unidade padr√£o primeiro
            if (data.unidade_padrao) {
                const opt = document.createElement('option');
                opt.value = data.unidade_padrao.id;
                opt.textContent = `${data.unidade_padrao.sigla} (padr√£o)`;
                opt.dataset.fator = data.unidade_padrao.fator;
                opt.dataset.sigla = data.unidade_padrao.sigla;
                opt.dataset.siglaPadrao = data.unidade_padrao.sigla;
                select.appendChild(opt);
            }
            
            // Adicionar unidades alternativas
            if (data.unidades_alternativas && data.unidades_alternativas.length > 0) {
                data.unidades_alternativas.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = `${u.sigla} (${u.fator}x ${data.unidade_padrao.sigla})`;
                    opt.dataset.fator = u.fator;
                    opt.dataset.sigla = u.sigla;
                    opt.dataset.siglaPadrao = data.unidade_padrao.sigla;
                    select.appendChild(opt);
                });
            }
            
            document.getElementById('add-unidades-section').classList.remove('hidden');
        })
        .catch(err => {
            console.error('Erro ao carregar unidades:', err);
            alert('Erro ao carregar unidades do produto');
        });
}

function atualizarConversaoAdicionar() {
    const select = document.getElementById('add-unidade');
    const qtd = parseFloat(document.getElementById('add-quantidade').value) || 0;
    const option = select.options[select.selectedIndex];
    
    if (!option || !option.dataset.fator) {
        document.getElementById('add-conversao-display').textContent = '';
        return;
    }
    
    const fator = parseFloat(option.dataset.fator);
    const siglaPadrao = option.dataset.siglaPadrao;
    
    if (fator !== 1.0 && qtd > 0) {
        const convertido = (qtd * fator).toFixed(2);
        document.getElementById('add-conversao-display').textContent = `= ${convertido} ${siglaPadrao}`;
    } else {
        document.getElementById('add-conversao-display').textContent = '';
    }
}

function adicionarNovoItem() {
    const produtoId = document.getElementById('add-produto-id').value;
    const unidadeId = document.getElementById('add-unidade').value;
    const quantidade = parseFloat(document.getElementById('add-quantidade').value);
    const preco = parseFloat(document.getElementById('add-preco').value);
    const observacao = document.getElementById('add-observacao').value.trim();
    
    if (!produtoId || !unidadeId || !quantidade || quantidade <= 0) {
        alert('Preencha todos os campos obrigat√≥rios');
        return;
    }
    
    const select = document.getElementById('add-unidade');
    const option = select.options[select.selectedIndex];
    const fator = parseFloat(option.dataset.fator) || 1.0;
    const sigla = option.dataset.sigla;
    
    fetch(`/lotes/${LOTE_ID}/item`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id_produto: produtoId,
            quantidade_original: quantidade,
            unidade_movimentacao: sigla,
            fator_conversao: fator,
            preco_custo_unitario: preco,
            observacao: observacao
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.item_id) {
            alert('‚úÖ Item adicionado!');
            location.reload();
        } else {
            alert('‚ùå Erro: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(err => alert('‚ùå Erro: ' + err.message));
}

</script>

<script>
// -------------------------
// Dados Financeiros
// -------------------------
document.addEventListener('DOMContentLoaded', () => {
    if ({{ 'true' if lote.tipo == 'ENTRADA' else 'false' }}) {
        initFinanceiro();
    }
});

function initFinanceiro() {
    const status = document.getElementById('financeiro-status');
    const aviso = document.getElementById('financeiro-aviso-leitura');
    const btnSalvar = document.getElementById('btn-salvar-financeiro');
    const btnGerar = document.getElementById('btn-gerar-parcelas');

    carregarCatalogosFinanceiros().then(() => {
        preencherFinanceiroInicial();
        if (!CAN_EDIT_FIN) {
            desabilitarFinanceiro();
            aviso.classList.remove('hidden');
            aviso.textContent = 'Edi√ß√£o bloqueada para status atual do lote.';
            if (btnSalvar) btnSalvar.classList.add('hidden');
            if (btnGerar) btnGerar.disabled = true;
        }
    });

    document.getElementById('financeiro-pago').addEventListener('change', togglePagamentoCampos);
    document.getElementById('financeiro-fornecedor-busca').addEventListener('input', filtrarFornecedores);
    document.getElementById('financeiro-plano-busca').addEventListener('input', filtrarPlanos);
    btnGerar.addEventListener('click', gerarParcelasAuto);
    document.getElementById('form-financeiro').addEventListener('submit', salvarFinanceiro);

    status.textContent = FINANCE_PREFILL ? 'Dados financeiros j√° salvos.' : 'Preencha e salve os dados financeiros.';
}

async function carregarCatalogosFinanceiros() {
    const [forResp, planoResp] = await Promise.all([
        fetch('/api/fornecedores?ativos=1'),
        fetch('/api/planos_contas?ativos=1')
    ]);
    FORNECEDORES_CACHE = await forResp.json();
    PLANOS_CACHE = await planoResp.json();

    popularSelect('financeiro-fornecedor', FORNECEDORES_CACHE, 'id', 'nome');
    popularSelect('financeiro-plano', PLANOS_CACHE, 'id', 'descricao');
}

function popularSelect(id, dados, valueKey, labelKey) {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">Selecione...</option>';
    dados.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item[valueKey];
        opt.textContent = item[labelKey];
        sel.appendChild(opt);
    });
}

function preencherFinanceiroInicial() {
    const valorTotalInput = document.getElementById('financeiro-valor-total');
    const emissaoInput = document.getElementById('financeiro-emissao');
    const numDocInput = document.getElementById('financeiro-num-doc');
    const fornecedorSel = document.getElementById('financeiro-fornecedor');
    const planoSel = document.getElementById('financeiro-plano');
    const obs = document.getElementById('financeiro-observacao');

    const pagoChk = document.getElementById('financeiro-pago');
    const valorPago = document.getElementById('financeiro-valor-pago');
    const dataPago = document.getElementById('financeiro-data-pago');

    if (FINANCE_PREFILL) {
        fornecedorSel.value = FINANCE_PREFILL.id_fornecedor;
        planoSel.value = FINANCE_PREFILL.id_plano_contas;
        numDocInput.value = FINANCE_PREFILL.num_doc || '';
        valorTotalInput.value = FINANCE_PREFILL.valor_total || '';
        emissaoInput.value = (FINANCE_PREFILL.data_emissao || '').split('T')[0] || '';
        obs.value = FINANCE_PREFILL.observacao || '';

        if (FINANCE_PREFILL.data_pagamento || FINANCE_PREFILL.valor_pago) {
            pagoChk.checked = true;
            valorPago.value = FINANCE_PREFILL.valor_pago || '';
            dataPago.value = (FINANCE_PREFILL.data_pagamento || '').split('T')[0] || '';
        }
        togglePagamentoCampos();
        renderParcelas(FINANCE_PARCELAS);
    } else {
        valorTotalInput.value = VALOR_ITENS_TOTAL || '';
        emissaoInput.value = new Date().toISOString().split('T')[0];
        renderParcelas([{ parcela_num: 1, valor: VALOR_ITENS_TOTAL || 0, data_vencimento: '' }]);
    }
    atualizarSomaParcelas();
}

function renderParcelas(parcelas) {
    const tbody = document.getElementById('parcelas-body');
    tbody.innerHTML = '';
    parcelas.forEach(parc => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-700';
        tr.innerHTML = `
            <td class="py-2 px-3">${parc.parcela_num}</td>
            <td class="py-2 px-3"><input type="date" class="bg-slate-700 rounded p-2 w-full" value="${parc.data_vencimento || ''}"></td>
            <td class="py-2 px-3"><input type="number" step="0.01" min="0" class="bg-slate-700 rounded p-2 w-full text-right" value="${Number(parc.valor || 0).toFixed(2)}"></td>
        `;
        tbody.appendChild(tr);
    });
    atualizarSomaParcelas();
}

function gerarParcelasAuto() {
    const qtd = parseInt(document.getElementById('financeiro-qtd-parcelas').value || '1', 10);
    const vencBase = document.getElementById('financeiro-venc-base').value;
    const total = parseFloat(document.getElementById('financeiro-valor-total').value || '0');
    if (!qtd || qtd < 1) return alert('Informe n¬∫ parcelas v√°lido');
    if (!vencBase) return alert('Informe o vencimento base');
    if (!total || total <= 0) return alert('Informe o valor total');

    const valorParcela = Math.round((total / qtd) * 100) / 100;
    const parcelas = [];
    let acumulado = 0;
    for (let i = 1; i <= qtd; i++) {
        let valor = valorParcela;
        acumulado += valorParcela;
        if (i === qtd) {
            valor = Math.round((total - (acumulado - valorParcela)) * 100) / 100;
        }
        const data = new Date(vencBase);
        data.setMonth(data.getMonth() + (i - 1));
        const dataStr = data.toISOString().substring(0, 10);
        parcelas.push({ parcela_num: i, valor, data_vencimento: dataStr });
    }
    renderParcelas(parcelas);
}

function atualizarSomaParcelas() {
    const tbody = document.getElementById('parcelas-body');
    const valores = Array.from(tbody.querySelectorAll('input[type="number"]')).map(i => parseFloat(i.value || '0'));
    const soma = valores.reduce((acc, v) => acc + v, 0);
    document.getElementById('parcelas-soma').textContent = `R$ ${soma.toFixed(2)}`;
}

function togglePagamentoCampos() {
    const chk = document.getElementById('financeiro-pago');
    const valor = document.getElementById('financeiro-valor-pago');
    const data = document.getElementById('financeiro-data-pago');
    const wrappers = document.querySelectorAll('.pagamento-field');
    const enabled = chk.checked;
    valor.disabled = !enabled;
    data.disabled = !enabled;
    wrappers.forEach(w => w.classList.toggle('hidden', !enabled));
    if (!enabled) {
        valor.value = '';
        data.value = '';
    }
}

function coletarParcelas() {
    const rows = Array.from(document.querySelectorAll('#parcelas-body tr'));
    return rows.map((tr, idx) => {
        const inputs = tr.querySelectorAll('input');
        return {
            parcela_num: idx + 1,
            data_vencimento: inputs[0].value || null,
            valor: parseFloat(inputs[1].value || '0')
        };
    });
}

function getSomaParcelas() {
    const parcelas = coletarParcelas();
    return parcelas.reduce((acc, p) => acc + (p.valor || 0), 0);
}

function valoresIguais(a, b) {
    return Math.abs((a || 0) - (b || 0)) < 0.01;
}

function filtrarFornecedores() {
    const termo = normalize(document.getElementById('financeiro-fornecedor-busca').value);
    const filtrados = FORNECEDORES_CACHE.filter(f => normalize(f.nome).includes(termo));
    popularSelect('financeiro-fornecedor', filtrados, 'id', 'nome');
    if (FINANCE_PREFILL && filtrados.some(f => f.id === FINANCE_PREFILL.id_fornecedor)) {
        document.getElementById('financeiro-fornecedor').value = FINANCE_PREFILL.id_fornecedor;
    }
}

function filtrarPlanos() {
    const termo = normalize(document.getElementById('financeiro-plano-busca').value);
    const filtrados = PLANOS_CACHE.filter(p => normalize(p.descricao || '').includes(termo) || normalize(p.codigo || '').includes(termo));
    popularSelect('financeiro-plano', filtrados, 'id', 'descricao');
    if (FINANCE_PREFILL && filtrados.some(p => p.id === FINANCE_PREFILL.id_plano_contas)) {
        document.getElementById('financeiro-plano').value = FINANCE_PREFILL.id_plano_contas;
    }
}

async function salvarFinanceiro(event) {
    event.preventDefault();
    if (!CAN_EDIT_FIN) return;

    const payload = {
        id_fornecedor: parseInt(document.getElementById('financeiro-fornecedor').value, 10),
        id_plano_contas: parseInt(document.getElementById('financeiro-plano').value, 10),
        num_doc: document.getElementById('financeiro-num-doc').value.trim(),
        observacao: document.getElementById('financeiro-observacao').value.trim(),
        valor_total: parseFloat(document.getElementById('financeiro-valor-total').value || '0'),
        data_emissao: document.getElementById('financeiro-emissao').value || null,
        parcelas: coletarParcelas()
    };

    const pago = document.getElementById('financeiro-pago').checked;
    if (pago) {
        payload.pagamento = {
            data_pagamento: document.getElementById('financeiro-data-pago').value,
            valor_pago: parseFloat(document.getElementById('financeiro-valor-pago').value || '0')
        };
    }

    const res = await fetch(`/lotes/${LOTE_ID}/financeiro`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok || !data.sucesso) {
        alert('Erro ao salvar: ' + (data.erro || res.statusText));
        return;
    }
    FINANCEIRO_SALVO = true;
    document.getElementById('financeiro-status').textContent = 'Dados financeiros salvos com sucesso.';
}

function validarFinanceiroPreAprovacao() {
    const erros = [];
    const fornecedor = document.getElementById('financeiro-fornecedor').value;
    const plano = document.getElementById('financeiro-plano').value;
    const valorTotalFin = parseFloat(document.getElementById('financeiro-valor-total').value || '0');
    const emissao = document.getElementById('financeiro-emissao').value;
    const pagoChk = document.getElementById('financeiro-pago');
    const valorPago = parseFloat(document.getElementById('financeiro-valor-pago').value || '0');
    const dataPago = document.getElementById('financeiro-data-pago').value;

    if (!fornecedor) erros.push('Selecione um fornecedor.');
    if (!plano) erros.push('Selecione um plano de contas.');
    if (!valorTotalFin || valorTotalFin <= 0) erros.push('Informe o valor total.');
    if (!emissao) erros.push('Informe a data de emiss√£o.');

    const parcelas = coletarParcelas();
    if (!parcelas.length) erros.push('Gere pelo menos uma parcela.');
    parcelas.forEach((p, idx) => {
        if (!p.data_vencimento) erros.push(`Informe o vencimento da parcela ${idx + 1}.`);
        if (!p.valor || p.valor <= 0) erros.push(`Informe o valor da parcela ${idx + 1}.`);
    });

    if (pagoChk && pagoChk.checked) {
        if (!valorPago || valorPago <= 0) erros.push('Informe o valor pago.');
        if (!dataPago) erros.push('Informe a data de pagamento.');
    }

    const valorItens = parseFloat(VALOR_ITENS_TOTAL || 0);
    const somaParcelas = getSomaParcelas();
    if (!valoresIguais(valorItens, valorTotalFin) || !valoresIguais(valorItens, somaParcelas)) {
        erros.push('Os valores devem ser iguais: total dos itens, total financeiro e soma das parcelas.');
    }

    if (!FINANCEIRO_SALVO) {
        erros.push('Clique em "Salvar dados financeiros" antes de aprovar.');
    }

    return erros;
}

function desabilitarFinanceiro() {
    document.querySelectorAll('#secao-financeiro input, #secao-financeiro select, #secao-financeiro button').forEach(el => {
        if (el.id === 'btn-salvar-financeiro') return;
        el.disabled = true;
    });
}
</script>
{% endblock %}
