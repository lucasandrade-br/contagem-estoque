{% extends "base.html" %}

{% block title %}Kardex - {{ produto.nome }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">üìä Dados Espec√≠ficos</h1>
                <p class="text-gray-400">Extrato completo de movimenta√ß√µes</p>
            </div>
            <a href="{{ url_for('admin.movimentacoes') }}" 
               class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-lg transition">
                ‚Üê Voltar para Movimenta√ß√µes
            </a>
        </div>
        
        <hr class="my-6 border-slate-700">
        
        <!-- Informa√ß√µes do Produto -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
            
            <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-500/30 rounded-lg p-6">
                <h1 class="text-3xl font-bold text-white mb-2">{{ produto.nome }}</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <div>
                        <div class="text-gray-400 text-sm mb-1">ID ERP</div>
                        <div class="text-white text-xl font-bold">{{ produto.id_erp or '-' }}</div>
                    </div>
                    
                    <div>
                        <div class="text-gray-400 text-sm mb-1">Unidade Padr√£o</div>
                        <div class="text-white text-xl font-bold">{{ produto.unidade_sigla or '-' }}</div>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-emerald-500/20 to-green-500/20 border border-emerald-500/30 rounded-lg p-6">
                <div class="text-emerald-400 text-sm font-semibold mb-2">üì¶ ESTOQUE ATUAL</div>
                <div class="text-white text-3xl font-bold">{{ produto.estoque_atual|round(2) }}</div>
                <div class="text-gray-400 text-xs mt-1">{{ produto.unidade_sigla or 'un.' }}</div>
            </div>

            <div class="bg-gradient-to-r from-amber-500/20 to-yellow-500/20 border border-amber-500/30 rounded-lg p-6">
                <div class="text-amber-400 text-sm font-semibold mb-2">üí∞ VALOR TOTAL</div>
                <div class="text-white text-3xl font-bold">R$ {{ (stats.valor_total_movimentacoes|default(0))|round(2) }}</div>
                <div class="text-gray-400 text-xs mt-1">Saldo em reais</div>
            </div>
        </div>

        <!-- Estat√≠sticas do Kardex -->
        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                <div class="text-blue-400 text-sm font-semibold mb-1">üî¢ SALDO INICIAL</div>
                <div class="text-2xl font-bold text-white">{{ stats.saldo_inicial|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_saldo_inicial|default(0))|round(2) }}</div>
            </div>
            <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
                <div class="text-emerald-400 text-sm font-semibold mb-1">üìà TOTAL ENTRADAS</div>
                <div class="text-2xl font-bold text-white">{{ stats.total_entradas|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_entradas|default(0))|round(2) }}</div>
            </div>
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                <div class="text-red-400 text-sm font-semibold mb-1">üìâ TOTAL SA√çDAS</div>
                <div class="text-2xl font-bold text-white">{{ stats.total_saidas|round(2) }}</div>
                <div class="text-xs text-gray-400 mt-1">R$ {{ (stats.valor_saidas|default(0))|round(2) }}</div>
            </div>
        </div>
        {% endif %}

        <!-- Filtros de Data -->
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-white">üîç Filtrar por Per√≠odo</h3>
                {% if filtros.data_inicio or filtros.data_fim %}
                <span class="bg-amber-500/20 text-amber-400 px-3 py-1 rounded text-xs font-semibold">
                    ‚úì Filtros Ativos
                </span>
                {% endif %}
            </div>
            <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Data In√≠cio</label>
                    <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}"
                           class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Data Fim</label>
                    <input type="date" name="data_fim" value="{{ filtros.data_fim }}"
                           class="w-full bg-slate-700 text-white border border-slate-600 rounded px-3 py-2">
                </div>

                <div class="flex items-end gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded transition">
                        üîç Filtrar
                    </button>
                    <a href="{{ url_for('admin.produto_kardex', produto_id=produto.id) }}" 
                       class="flex-1 bg-slate-600 hover:bg-slate-500 text-white px-6 py-2 rounded transition text-center">
                        üîÑ Limpar
                    </a>
                </div>
            </form>
        </div>

        <!-- Tabela Kardex com Saldo -->
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg overflow-hidden">
            <div class="bg-slate-700/50 px-4 py-3 border-b border-slate-600">
                <h2 class="text-lg font-bold text-white">üìã Hist√≥rico de Movimenta√ß√µes</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-700/30">
                        <tr class="text-left text-gray-300 font-semibold">
                            <th class="p-3">Data/Hora</th>
                            <th class="p-3">Tipo</th>
                            <th class="p-3">Motivo</th>
                            <th class="p-3 text-right">Quantidade</th>
                            <th class="p-3 text-right">Pre√ßo Unit.</th>
                            <th class="p-3 text-right">Valor Total</th>
                            <th class="p-3 text-right bg-slate-700/50">Saldo</th>
                            <th class="p-3">Origem</th>
                            <th class="p-3">Usu√°rio</th>
                            <th class="p-3">Observa√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-300">
                        {% if movimentacoes %}
                            {% for mov in movimentacoes %}
                            <tr class="border-t border-slate-700 hover:bg-slate-700/20 transition">
                                <td class="p-3 font-mono text-xs">
                                    {{ mov.data_movimento[:10] }}
                                    <div class="text-gray-500">{{ mov.data_movimento[11:19] }}</div>
                                </td>
                                <td class="p-3">
                                    {% if mov.tipo == 'ENTRADA' %}
                                    <span class="bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded text-xs font-bold inline-block">
                                        üìà ENTRADA
                                    </span>
                                    {% else %}
                                    <span class="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs font-bold inline-block">
                                        üìâ SA√çDA
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="p-3">
                                    <span class="bg-slate-600/50 text-gray-300 px-2 py-1 rounded text-xs">
                                        {{ mov.motivo.replace('_', ' ') }}
                                    </span>
                                </td>
                                <td class="p-3 text-right font-mono font-bold">
                                    {% if mov.fator_conversao_usado and mov.fator_conversao_usado != 1.0 %}
                                        {% if mov.tipo == 'ENTRADA' %}
                                        <span class="text-emerald-400">+{{ mov.quantidade_original|round(2) }} {{ mov.unidade_movimentacao }}</span>
                                        <div class="text-xs text-gray-500 font-normal">({{ mov.quantidade|round(2) }} un.)</div>
                                        {% else %}
                                        <span class="text-red-400">-{{ mov.quantidade_original|round(2) }} {{ mov.unidade_movimentacao }}</span>
                                        <div class="text-xs text-gray-500 font-normal">({{ mov.quantidade|round(2) }} un.)</div>
                                        {% endif %}
                                    {% else %}
                                        {% if mov.tipo == 'ENTRADA' %}
                                        <span class="text-emerald-400">+{{ mov.quantidade|round(2) }}</span>
                                        {% else %}
                                        <span class="text-red-400">-{{ mov.quantidade|round(2) }}</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="p-3 text-right font-mono text-sm text-gray-300">
                                    R$ {{ mov.preco_custo_unitario|default(0)|round(2) }}
                                </td>
                                <td class="p-3 text-right font-mono font-bold {% if mov.tipo == 'ENTRADA' %}text-emerald-400{% else %}text-red-400{% endif %}">
                                    R$ {{ mov.valor_total|default(0)|round(2) }}
                                </td>
                                <td class="p-3 text-right font-mono font-bold text-lg bg-slate-700/30">
                                    <span class="{% if mov.saldo < 0 %}text-red-400{% elif mov.saldo == 0 %}text-gray-400{% else %}text-white{% endif %}">
                                        {{ mov.saldo|round(2) }}
                                    </span>
                                </td>
                                <td class="p-3 text-xs text-gray-400">
                                    {{ mov.origem or '-' }}
                                </td>
                                <td class="p-3 text-sm">
                                    {{ mov.usuario_nome or 'Sistema' }}
                                </td>
                                <td class="p-3 text-xs text-gray-400 max-w-xs truncate" title="{{ mov.observacao }}">
                                    {{ mov.observacao or '-' }}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="p-8 text-center text-gray-400">
                                <div class="text-6xl mb-4">üì≠</div>
                                <div class="text-lg">Nenhuma movimenta√ß√£o registrada para este produto.</div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- A√ß√µes -->
        <div class="mt-6 flex gap-4">
            <a href="{{ url_for('admin.movimentacoes') }}" 
               class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition shadow-lg">
                üìã Ver Todas Movimenta√ß√µes
            </a>
            <button onclick="window.print()" 
                    class="bg-slate-600 hover:bg-slate-500 text-white px-6 py-3 rounded-lg transition">
                üñ®Ô∏è Imprimir Kardex
            </button>
        </div>
    </div>
</div>

<style>
@media print {
    .no-print, button, a {
        display: none !important;
    }
    
    body {
        background: white !important;
    }
    
    .bg-slate-800, .bg-slate-700 {
        background: white !important;
        border: 1px solid #333 !important;
    }
    
    .text-white {
        color: #000 !important;
    }
    
    table {
        border-collapse: collapse;
    }
    
    th, td {
        border: 1px solid #999 !important;
    }
}
</style>
{% endblock %}
