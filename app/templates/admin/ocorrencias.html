{% extends "base.html" %}

{% block title %}Gest√£o de Ocorr√™ncias{% endblock %}

{% block content %}
<div class="min-h-screen p-6 bg-slate-900 text-gray-100">
    <div class="max-w-7xl mx-auto">
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-amber-500">Gest√£o de Ocorr√™ncias</h1>
                <p class="text-gray-400 text-sm mt-1">Itens n√£o identificados reportados durante o invent√°rio.</p>
            </div>
            <a href="{{ url_for('admin.dashboard') }}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-gray-200 transition">
                ‚Üê Voltar ao Dashboard
            </a>
        </div>

        <div class="bg-slate-800 rounded-lg shadow-xl overflow-hidden border border-slate-700">
            {% if ocorrencias|length > 0 %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-900 text-gray-400 text-sm uppercase tracking-wider">
                            <th class="p-4 border-b border-slate-700 w-20">Foto</th>
                            <th class="p-4 border-b border-slate-700">O que foi reportado</th>
                            <th class="p-4 border-b border-slate-700">Local / Data</th>
                            <th class="p-4 border-b border-slate-700 text-center">Quantidade</th>
                            <th class="p-4 border-b border-slate-700 text-right">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700">
                        {% for item in ocorrencias %}
                        <tr class="hover:bg-slate-700/50 transition duration-150">
                            <td class="p-4">
                                <div class="w-12 h-12 rounded bg-slate-900 border border-slate-600 flex items-center justify-center overflow-hidden cursor-pointer"
                                    onclick='abrirAnalise({{ item|tojson }})'>
                                    {% if item.foto_path %}
                                        <img src="{{ url_for('static', filename=item.foto_path) }}" class="w-full h-full object-cover">
                                    {% else %}
                                        <span class="text-xl">üì∑</span>
                                    {% endif %}
                                </div>
                            </td>

                            <td class="p-4">
                                <p class="font-bold text-gray-100 text-lg">{{ item.nome_identificado }}</p>
                                <p class="text-xs text-amber-500 font-mono">ID Ocorr√™ncia: #{{ item.id }}</p>
                            </td>

                            <td class="p-4">
                                <div class="flex items-center gap-2">
                                    <span class="bg-slate-600 px-2 py-1 rounded text-xs font-bold">{{ item.local_nome }}</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">{{ item.data_hora }}</p>
                            </td>

                            <td class="p-4 text-center">
                                <span class="text-xl font-bold text-emerald-400">{{ item.quantidade }}</span>
                                <span class="text-sm text-gray-400 ml-1">{{ item.unidade_sigla }}</span>
                            </td>

                            <td class="p-4 text-right">
                                <button onclick='abrirAnalise({{ item|tojson }})' 
                                        class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow hover:shadow-lg transition font-medium flex items-center gap-2 ml-auto">
                                    <span>üîç</span> Analisar
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-10 text-center text-gray-400">
                <p class="text-xl">üéâ Nenhuma ocorr√™ncia pendente!</p>
                <p class="text-sm mt-2">O invent√°rio pode ser fechado com seguran√ßa.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="modalAnalise" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-slate-900 rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col border border-slate-600 shadow-2xl overflow-hidden">
        
        <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                üîé Analisar Ocorr√™ncia <span id="analise-id" class="text-amber-500 text-sm"></span>
            </h3>
            <button onclick="fecharAnalise()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>

        <div class="flex-1 overflow-y-auto p-0">
            <div class="grid grid-cols-1 md:grid-cols-2 h-full">
                
                <div class="bg-black flex flex-col items-center justify-center p-4 border-r border-slate-700 relative group">
                    <img id="analise-foto" src="" class="max-h-[400px] w-auto object-contain rounded shadow-lg hidden">
                    <div id="analise-sem-foto" class="text-gray-500 flex flex-col items-center hidden">
                        <span class="text-6xl mb-4">üì∑</span>
                        <p>Sem foto dispon√≠vel</p>
                    </div>
                    
                    <div class="w-full mt-6 bg-slate-800/50 p-4 rounded border border-slate-700">
                        <label class="text-xs text-gray-400 uppercase font-bold">O Estoquista informou:</label>
                        <p id="analise-nome" class="text-xl font-bold text-white mt-1"></p>
                        <div class="flex justify-between mt-2">
                            <p class="text-emerald-400 font-bold text-lg">
                                <span id="analise-qtd"></span> <span id="analise-unidade"></span>
                            </p>
                            <p id="analise-local" class="text-gray-300 text-sm bg-slate-700 px-2 py-1 rounded"></p>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-slate-900 flex flex-col gap-6">
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-blue-400 border-b border-slate-700 pb-2">Op√ß√£o 1: Vincular a Produto Existente</h4>
                        <p class="text-sm text-gray-400">Se este item j√° existe no cadastro, mas o estoquista n√£o encontrou.</p>
                        
                        <div class="relative">
                            <input type="text" id="busca-vinculo" placeholder="Digite o nome do produto correto..." 
                                   class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <div id="lista-resultados" class="hidden absolute top-full left-0 w-full bg-slate-800 border border-slate-600 max-h-40 overflow-y-auto z-10 shadow-xl rounded-b">
                                </div>
                        </div>
                        
                        <div id="produto-selecionado" class="hidden bg-blue-900/30 border border-blue-500/50 p-3 rounded flex justify-between items-center">
                            <div>
                                <p class="text-blue-300 text-xs font-bold">VINCULAR A:</p>
                                <p id="vinculo-nome" class="font-bold text-white"></p>
                                <input type="hidden" id="vinculo-id">
                            </div>
                            <button onclick="confirmarVinculo()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold shadow-lg transform hover:scale-105 transition">
                                Confirmar
                            </button>
                        </div>
                    </div>

                    <div class="border-t border-slate-700 my-2"></div>

                    <div>
                        <h4 class="text-lg font-semibold text-emerald-400 mb-2">Op√ß√£o 2: Cadastrar Novo</h4>
                        <p class="text-sm text-gray-400 mb-3">Se √© um produto realmente novo que chegou agora.</p>
                        <button onclick="iniciarCadastroNovo()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold flex items-center justify-center gap-2 shadow-lg transition">
                            <span>‚ú®</span> Abrir Formul√°rio de Cadastro
                        </button>
                    </div>

                    <div class="border-t border-slate-700 my-2"></div>

                    <div>
                        <h4 class="text-lg font-semibold text-rose-400 mb-2">Op√ß√£o 3: Rejeitar</h4>
                        <p class="text-sm text-gray-400 mb-3">Se for lixo, erro ou duplicidade.</p>
                        <button onclick="rejeitarOcorrencia()" class="w-full py-2 border border-rose-600 text-rose-500 hover:bg-rose-600 hover:text-white rounded font-bold transition">
                            üóëÔ∏è Ignorar esta ocorr√™ncia
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE VALIDA√á√ÉO -->
<div id="modalValidacao" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-slate-900 rounded-xl w-full max-w-5xl max-h-[90vh] overflow-y-auto border border-slate-600 shadow-2xl">
        
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-slate-700 bg-slate-800">
            <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                ‚úÖ Revisar Vincula√ß√£o
            </h3>
            <button onclick="fecharValidacao()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>

        <!-- Conte√∫do em 2 colunas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
            
            <!-- COLUNA ESQUERDA: DADOS DA OCORR√äNCIA (readonly) -->
            <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                <h4 class="text-lg font-bold text-amber-500 mb-4 flex items-center gap-2">
                    üì¶ DADOS DA OCORR√äNCIA
                </h4>
                
                <div class="space-y-3 text-sm">
                    <div>
                        <label class="text-gray-400 font-semibold">Registrado por:</label>
                        <p id="val-usuario" class="text-white font-bold"></p>
                    </div>
                    
                    <div>
                        <label class="text-gray-400 font-semibold">Data/Hora:</label>
                        <p id="val-data" class="text-white"></p>
                    </div>
                    
                    <div>
                        <label class="text-gray-400 font-semibold">Local:</label>
                        <p id="val-local" class="text-white bg-slate-700 inline-block px-3 py-1 rounded"></p>
                    </div>
                    
                    <div class="pt-3 border-t border-slate-600">
                        <label class="text-gray-400 font-semibold">Nome informado:</label>
                        <p id="val-nome-original" class="text-white text-lg font-bold"></p>
                    </div>
                    
                    <div>
                        <label class="text-gray-400 font-semibold">Quantidade original:</label>
                        <p id="val-qtd-original" class="text-emerald-400 text-xl font-bold"></p>
                    </div>
                    
                    <div>
                        <label class="text-gray-400 font-semibold">Unidade original:</label>
                        <p id="val-unidade-original" class="text-white"></p>
                    </div>
                    
                    <!-- Foto -->
                    <div class="pt-3">
                        <label class="text-gray-400 font-semibold block mb-2">Foto:</label>
                        <div id="val-foto-container" class="hidden">
                            <img id="val-foto" src="" class="w-full h-48 object-cover rounded border border-slate-600">
                        </div>
                        <div id="val-sem-foto" class="hidden text-gray-500 text-center py-8">
                            <span class="text-4xl">üì∑</span>
                            <p class="mt-2">Sem foto</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- COLUNA DIREITA: AJUSTAR DADOS + PRODUTO VINCULADO -->
            <div class="space-y-6">
                
                <!-- SE√á√ÉO: AJUSTAR DADOS (edit√°vel) -->
                <div class="bg-slate-800 rounded-lg p-6 border border-blue-500/50">
                    <h4 class="text-lg font-bold text-blue-400 mb-4 flex items-center gap-2">
                        ‚úèÔ∏è AJUSTAR DADOS
                    </h4>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-300 font-semibold mb-2">Quantidade:</label>
                            <input type="number" 
                                   id="val-quantidade-edit" 
                                   step="0.01" 
                                   min="0.01"
                                   class="w-full text-2xl p-3 bg-slate-700 text-gray-100 rounded-lg text-center font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-300 font-semibold mb-2">Unidade:</label>
                            <select id="val-unidade-edit" 
                                    class="w-full p-3 bg-slate-700 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- Ser√° preenchido dinamicamente -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SEPARADOR -->
                <div class="border-t-2 border-slate-700"></div>
                
                <!-- SE√á√ÉO: PRODUTO VINCULADO -->
                <div class="bg-slate-800 rounded-lg p-6 border border-emerald-500/50">
                    <h4 class="text-lg font-bold text-emerald-400 mb-4 flex items-center gap-2">
                        üîó PRODUTO VINCULADO
                    </h4>
                    
                    <div class="space-y-3 text-sm">
                        <div>
                            <label class="text-gray-400 font-semibold">Nome do Produto:</label>
                            <p id="val-produto-nome" class="text-white text-lg font-bold"></p>
                        </div>
                        
                        <div>
                            <label class="text-gray-400 font-semibold">ID ERP:</label>
                            <p id="val-produto-erp" class="text-white font-mono"></p>
                        </div>
                        
                        <div>
                            <label class="text-gray-400 font-semibold">GTIN/C√≥digo:</label>
                            <p id="val-produto-gtin" class="text-white font-mono"></p>
                        </div>
                        
                        <div>
                            <label class="text-gray-400 font-semibold">Unidade Padr√£o:</label>
                            <p id="val-produto-unidade-padrao" class="text-white"></p>
                        </div>
                    </div>
                    
                    <button onclick="trocarProduto()" 
                            class="mt-4 w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition font-semibold flex items-center justify-center gap-2">
                        üîÑ Trocar Produto
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Rodap√© com bot√µes -->
        <div class="flex gap-4 p-6 border-t border-slate-700 bg-slate-800">
            <button onclick="cancelarValidacao()" 
                    class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition font-bold">
                CANCELAR
            </button>
            <button onclick="confirmarVinculacaoFinal()" 
                    class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition font-bold flex items-center justify-center gap-2">
                <span>‚úì</span> CONFIRMAR VINCULA√á√ÉO
            </button>
        </div>
    </div>
</div>

<input type="hidden" id="id_ocorrencia_atual">
<input type="hidden" id="id_produto_vinculado">

{% include 'includes/modal_produto.html' %}

<script src="{{ url_for('static', filename='js/produto_modal.js') }}"></script>

<script>
    // Dados globais para busca r√°pida
    const todosProdutos = {{ produtos | tojson }}; 
    // Certifique-se que sua rota render_template envie 'produtos=produtos'
    // Se n√£o estiver enviando, precisaremos fazer fetch. 
    // Assumindo que voc√™ vai adicionar 'produtos=db.execute("SELECT * FROM produtos WHERE ativo=1").fetchall()' no app.py

    // --- L√ìGICA DO MODAL DE AN√ÅLISE ---

    // Vari√°vel global para guardar dados completos da ocorr√™ncia atual
    let ocorrenciaAtualCompleta = null;

    function abrirAnalise(item) {
        // Guarda dados completos
        ocorrenciaAtualCompleta = item;
        
        document.getElementById('id_ocorrencia_atual').value = item.id;
        document.getElementById('analise-id').innerText = '#' + item.id;
        
        // Preenche dados
        document.getElementById('analise-nome').innerText = item.nome_identificado;
        document.getElementById('analise-qtd').innerText = item.quantidade;
        document.getElementById('analise-unidade').innerText = item.unidade_sigla; // Certifique-se que o SQL traz a sigla
        document.getElementById('analise-local').innerText = item.local_nome;

        // Trata Foto
        const img = document.getElementById('analise-foto');
        const noImg = document.getElementById('analise-sem-foto');
        
        if (item.foto_path) {
            // Como salvamos relativo no banco (uploads/...), basta adicionar /static/ na frente
            img.src = item.foto_path;
            img.classList.remove('hidden');
            noImg.classList.add('hidden');
        } else {
            img.classList.add('hidden');
            noImg.classList.remove('hidden');
        }

        // Reseta estados
        document.getElementById('busca-vinculo').value = '';
        document.getElementById('lista-resultados').classList.add('hidden');
        document.getElementById('produto-selecionado').classList.add('hidden');

        document.getElementById('modalAnalise').classList.remove('hidden');
    }

    function fecharAnalise() {
        document.getElementById('modalAnalise').classList.add('hidden');
    }

    // --- L√ìGICA DE BUSCA DE V√çNCULO ---

    const inputBusca = document.getElementById('busca-vinculo');
    const listaRes = document.getElementById('lista-resultados');

    inputBusca.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        if(termo.length < 2) {
            listaRes.classList.add('hidden');
            return;
        }

        // Filtra produtos (Assumindo que todosProdutos foi carregado)
        // Se a lista for muito grande, ideal √© fazer fetch API, mas para <5000 itens JS aguenta
        const resultados = todosProdutos.filter(p => p.nome.toLowerCase().includes(termo)).slice(0, 10);

        listaRes.innerHTML = '';
        if(resultados.length === 0) {
            listaRes.innerHTML = '<div class="p-3 text-gray-400">Nenhum produto encontrado.</div>';
        } else {
            resultados.forEach(p => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-0';
                div.innerHTML = `<div class="font-bold text-white">${p.nome}</div>`;
                div.onclick = () => selecionarVinculo(p);
                listaRes.appendChild(div);
            });
        }
        listaRes.classList.remove('hidden');
    });

    function selecionarVinculo(produto) {
        document.getElementById('vinculo-id').value = produto.id;
        document.getElementById('vinculo-nome').innerText = produto.nome;
        document.getElementById('produto-selecionado').classList.remove('hidden');
        listaRes.classList.add('hidden');
        inputBusca.value = '';
    }

    // --- A√á√ïES FINAIS ---

    function confirmarVinculo() {
        const idOcorrencia = document.getElementById('id_ocorrencia_atual').value;
        const idProduto = document.getElementById('vinculo-id').value;

        if(!idProduto) return alert('Selecione um produto primeiro.');

        // Busca dados da ocorr√™ncia e do produto
        const ocorrencia = obterDadosOcorrenciaAtual();
        const produto = todosProdutos.find(p => p.id == idProduto);

        if (!produto) return alert('Produto n√£o encontrado.');

        // Abre modal de valida√ß√£o
        abrirModalValidacao(ocorrencia, produto);
    }

    // =========================
    // MODAL DE VALIDA√á√ÉO
    // =========================

    function obterDadosOcorrenciaAtual() {
        return {
            id: document.getElementById('id_ocorrencia_atual').value,
            nome: document.getElementById('analise-nome').innerText,
            quantidade: document.getElementById('analise-qtd').innerText,
            unidade: document.getElementById('analise-unidade').innerText,
            local: document.getElementById('analise-local').innerText,
            foto: document.getElementById('analise-foto').src || null,
            usuario: ocorrenciaAtualCompleta?.usuario_nome || 'Estoquista',
            data: ocorrenciaAtualCompleta?.data_hora || new Date().toLocaleString('pt-BR')
        };
    }

    function abrirModalValidacao(ocorrencia, produto) {
        // Fecha modal de an√°lise
        fecharAnalise();

        // Preenche dados da ocorr√™ncia (coluna esquerda - readonly)
        document.getElementById('val-usuario').innerText = ocorrencia.usuario;
        document.getElementById('val-data').innerText = ocorrencia.data;
        document.getElementById('val-local').innerText = ocorrencia.local;
        document.getElementById('val-nome-original').innerText = ocorrencia.nome;
        document.getElementById('val-qtd-original').innerText = ocorrencia.quantidade;
        document.getElementById('val-unidade-original').innerText = ocorrencia.unidade;

        // Foto
        if (ocorrencia.foto && ocorrencia.foto !== '') {
            document.getElementById('val-foto').src = ocorrencia.foto;
            document.getElementById('val-foto-container').classList.remove('hidden');
            document.getElementById('val-sem-foto').classList.add('hidden');
        } else {
            document.getElementById('val-foto-container').classList.add('hidden');
            document.getElementById('val-sem-foto').classList.remove('hidden');
        }

        // Preenche campos edit√°veis (inicia com valores originais)
        document.getElementById('val-quantidade-edit').value = parseFloat(ocorrencia.quantidade);
        
        // Popula select de unidades
        const selectUnidade = document.getElementById('val-unidade-edit');
        selectUnidade.innerHTML = '';
        
        const unidadesDisponiveis = {{ unidades | tojson | safe }};
        unidadesDisponiveis.forEach(u => {
            const option = document.createElement('option');
            option.value = u.id;
            option.textContent = `${u.sigla} - ${u.nome}`;
            if (u.sigla === ocorrencia.unidade) {
                option.selected = true;
            }
            selectUnidade.appendChild(option);
        });

        // SE PRODUTO FOI FORNECIDO: preenche dados do produto vinculado (coluna direita)
        if (produto) {
            preencherDadosProdutoValidacao(produto);
        } else {
            // SE N√ÉO: Mostra mensagem aguardando cadastro
            document.getElementById('val-produto-nome').innerText = 'Aguardando cadastro...';
            document.getElementById('val-produto-erp').innerText = '-';
            document.getElementById('val-produto-gtin').innerText = '-';
            document.getElementById('val-produto-unidade-padrao').innerText = '-';
            document.getElementById('id_produto_vinculado').value = '';
        }

        // Abre modal
        document.getElementById('modalValidacao').classList.remove('hidden');
    }

    function preencherDadosProdutoValidacao(produto) {
        // Preenche dados do produto vinculado (coluna direita do modal de valida√ß√£o)
        document.getElementById('val-produto-nome').innerText = produto.nome;
        document.getElementById('val-produto-erp').innerText = produto.id_erp || 'N/A';
        document.getElementById('val-produto-gtin').innerText = produto.gtin || 'N/A';
        
        // Busca unidade padr√£o do produto
        const unidadesDisponiveis = {{ unidades | tojson | safe }};
        const unidadePadrao = unidadesDisponiveis.find(u => u.id === produto.id_unidade_padrao);
        document.getElementById('val-produto-unidade-padrao').innerText = unidadePadrao ? unidadePadrao.sigla : 'N/A';

        // Guarda ID do produto vinculado
        document.getElementById('id_produto_vinculado').value = produto.id;
    }

    function fecharValidacao() {
        document.getElementById('modalValidacao').classList.add('hidden');
    }

    function cancelarValidacao() {
        if (confirm('Deseja cancelar esta valida√ß√£o? Voc√™ voltar√° para a lista de ocorr√™ncias.')) {
            fecharValidacao();
            // Opcionalmente, reabrir modal de an√°lise ou apenas fechar
        }
    }

    function trocarProduto() {
        // Volta para o modal de an√°lise para permitir nova busca
        fecharValidacao();
        
        // Reabre modal de an√°lise com dados j√° preenchidos
        const idOcorrencia = document.getElementById('id_ocorrencia_atual').value;
        // Precisamos buscar os dados originais novamente ou guardar em mem√≥ria
        // Por simplicidade, vou reabrir o modal vazio e o usu√°rio busca novamente
        document.getElementById('modalAnalise').classList.remove('hidden');
        
        // Limpa sele√ß√£o anterior
        document.getElementById('produto-selecionado').classList.add('hidden');
    }

    async function confirmarVinculacaoFinal() {
        const idOcorrencia = document.getElementById('id_ocorrencia_atual').value;
        const idProduto = document.getElementById('id_produto_vinculado').value;
        const quantidade = parseFloat(document.getElementById('val-quantidade-edit').value);
        const unidadeId = parseInt(document.getElementById('val-unidade-edit').value);

        // Valida√ß√µes
        if (!quantidade || quantidade <= 0) {
            return alert('Quantidade deve ser maior que zero.');
        }

        if (!unidadeId) {
            return alert('Selecione uma unidade.');
        }

        try {
            const res = await fetch('/api/vincular_ocorrencia', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    id_ocorrencia: idOcorrencia, 
                    id_produto_destino: idProduto,
                    quantidade: quantidade,
                    unidade_id: unidadeId
                })
            });
            const data = await res.json();
            
            if(data.sucesso) {
                alert('Vincula√ß√£o confirmada com sucesso!');
                location.reload();
            } else {
                alert(data.erro || 'Erro ao vincular.');
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conex√£o.');
        }
    }

    function iniciarCadastroNovo() {
        const nomeAtual = document.getElementById('analise-nome').innerText;
        const idOcorrencia = document.getElementById('id_ocorrencia_atual').value;

        // Prepara objeto de ocorr√™ncia
        const ocorrencia = {
            id: idOcorrencia,
            nome: document.getElementById('analise-nome').innerText,
            quantidade: document.getElementById('analise-qtd').innerText,
            unidade: document.getElementById('analise-unidade').innerText,
            local: document.getElementById('analise-local').innerText,
            foto: document.getElementById('analise-foto').src || null,
            usuario: ocorrenciaAtualCompleta?.usuario_nome || 'Estoquista',
            data: ocorrenciaAtualCompleta?.data_hora || new Date().toLocaleString('pt-BR')
        };

        // 1. ABRE MODAL DE VALIDA√á√ÉO PRIMEIRO (sem produto ainda)
        abrirModalValidacao(ocorrencia, null);
        
        // 2. AGORA ABRE MODAL DE CADASTRO POR CIMA
        abrirModalProduto();
        
        // Preenche automaticamente
        document.getElementById('prod_nome').value = nomeAtual;
        
        // SETA O CONTEXTO PARA O SCRIPT DO MODAL SABER QUE √â OCORR√äNCIA
        window.contextoOcorrenciaId = idOcorrencia; 
        
        // Muda t√≠tulo para dar feedback
        document.getElementById('modalTitulo').innerText = "Cadastrar a partir de Ocorr√™ncia";
    }

    async function rejeitarOcorrencia() {
        if(!confirm('Tem certeza que deseja rejeitar esta contagem? Ela n√£o entrar√° no estoque.')) return;
        
        const id = document.getElementById('id_ocorrencia_atual').value;
        // Precisamos criar essa rota no backend se n√£o existir, ou usar uma gen√©rica
        // Vou assumir que voc√™ criou /api/rejeitar_ocorrencia/<id>
        try {
            const res = await fetch(`/api/rejeitar_ocorrencia/${id}`, { method: 'POST' });
            const data = await res.json();
            if(data.sucesso || data.success) { // Tratando inconsist√™ncia de nomes
                location.reload();
            } else {
                alert('Erro ao rejeitar.');
            }
        } catch (e) {
            alert('Erro de conex√£o.');
        }
    }

    // --- INTEGRA√á√ÉO COM O MODAL DE PRODUTO (OVERRIDE DO SUBMIT) ---
    // Precisamos interceptar o submit do modal_produto para saber se √© um cadastro normal ou de ocorr√™ncia

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('formProduto');
        
        // Remove listeners antigos (truque para n√£o duplicar submit se o script rodar 2x)
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        newForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // VERIFICA SE ESTAMOS NO CONTEXTO DE OCORR√äNCIA
            let url = '{{ url_for("admin.admin_produtos") }}'; // Rota padr√£o de salvar produto normal
            
            if (window.contextoOcorrenciaId) {
                url = '/api/cadastrar_da_ocorrencia';
                formData.append('id_ocorrencia', window.contextoOcorrenciaId);
            }

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if(data.sucesso) {
                    // SE FOR CONTEXTO DE OCORR√äNCIA: preenche produto no modal de valida√ß√£o que j√° est√° aberto
                    if (window.contextoOcorrenciaId && data.produto) {
                        // Fecha modal de produto
                        fecharModalProduto();
                        
                        // Preenche os dados do produto criado no modal de valida√ß√£o que j√° est√° aberto
                        preencherDadosProdutoValidacao(data.produto);
                        
                        alert('Produto cadastrado! Revise os dados e confirme a vincula√ß√£o.');
                        
                        // Limpa o contexto
                        window.contextoOcorrenciaId = null;
                    } else {
                        // Cadastro normal de produto (fora de ocorr√™ncia)
                        alert('Opera√ß√£o realizada!');
                        location.reload();
                    }
                } else {
                    alert(data.erro || 'Erro ao salvar.');
                }
            } catch (err) {
                console.error(err);
                alert('Erro de conex√£o.');
            }
        });
    });

</script>
{% endblock %}